# Plan 05-02: Fix Session Management in User Creation

**Status:** âœ… COMPLETE (2026-02-16)

## Goal

Prevent session hijacking when admin creates a new user. Ensure admin session is verified before subsequent database operations.

## Problem

`supabase.auth.signUp()` automatically logs in as the new user, replacing the admin's session. While `adminCreateUser()` attempts to restore the session, there's no verification that it succeeded before `tenantsApi.createUser()` does the `tenant_users` INSERT.

## Tasks

### Task 1: Add Session Verification to auth.ts
- [ ] After session restoration, verify `auth.uid()` matches original admin
- [ ] Throw clear error if session restoration failed
- [ ] Add retry logic for transient failures

### Task 2: Add Session Check in tenants.ts
- [ ] Before `tenant_users` INSERT, verify current user matches expected admin
- [ ] If session mismatch, attempt restoration before proceeding
- [ ] Add transaction-like rollback: delete auth user if tenant_users fails

### Task 3: Improve Error Messages
- [ ] Distinguish between RLS errors and session errors
- [ ] Provide actionable error messages to UI

### Task 4: Add Logging for Debugging
- [ ] Log session state before/after signUp (dev only)
- [ ] Log which user is performing the INSERT

## Implementation

### auth.ts Changes

```typescript
// In adminCreateUser(), after session restoration:
async function adminCreateUser(input: AdminCreateUserInput) {
  // ... existing code to save session and create user ...

  // After restoring session, VERIFY it worked
  const { data: verifySession } = await supabase.auth.getSession()
  if (verifySession.session?.user.id !== adminSession?.user.id) {
    // Session restoration failed - try again
    const { error: retryError } = await supabase.auth.setSession({
      access_token: adminSession!.access_token,
      refresh_token: adminSession!.refresh_token,
    })

    if (retryError) {
      throw new Error(
        `Failed to restore admin session after user creation. ` +
        `Please refresh the page and try again. User may have been created.`
      )
    }

    // Verify again
    const { data: finalSession } = await supabase.auth.getSession()
    if (finalSession.session?.user.id !== adminSession?.user.id) {
      throw new Error('Session verification failed after retry')
    }
  }

  return { userId: newUser.id, profile }
}
```

### tenants.ts Changes

```typescript
async function createUser(tenantId: string, input: CreateUserInput) {
  // Get current session to verify we're still admin
  const { data: { session } } = await supabase.auth.getSession()
  const adminUserId = session?.user.id

  if (!adminUserId) {
    throw new Error('No active session. Please log in again.')
  }

  // Create auth user (this handles session save/restore)
  const { userId, profile } = await authApi.adminCreateUser({...})

  // Verify session is still admin before tenant_users INSERT
  const { data: { session: postSession } } = await supabase.auth.getSession()
  if (postSession?.user.id !== adminUserId) {
    // Session changed unexpectedly - this is a critical error
    // Note: We can't easily delete the auth user without admin API
    throw new Error(
      'Session changed during user creation. ' +
      'The user may have been created but not added to the tenant. ' +
      'Please check the user list and refresh the page.'
    )
  }

  // Now safe to INSERT into tenant_users
  const { data: tenantUser, error: tenantError } = await supabase
    .from('tenant_users')
    .insert({...})

  if (tenantError) {
    // TODO: Consider cleanup of orphaned auth user
    throw new Error(`User created but failed to add to tenant: ${tenantError.message}`)
  }

  return { user: profile, tenantUser }
}
```

## Verification

- [ ] Create user as OrgAdmin - admin stays logged in
- [ ] Create multiple users in sequence - no session issues
- [ ] Simulate network failure - appropriate error shown
- [ ] After user creation, admin can still perform other operations
- [ ] Page refresh not required after creating user

## Estimated Effort

Medium - 2-3 hours
