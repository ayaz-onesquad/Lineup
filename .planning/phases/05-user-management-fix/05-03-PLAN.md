# Plan 05-03: Improve UI Validation and Error Handling

**Status:** âœ… COMPLETE (2026-02-16)

## Goal

Add proper validation, error handling, and user feedback to TeamPage and AdminTenantDetailPage for user creation.

## Tasks

### Task 1: Add Pre-Flight Validation in TeamPage
- [ ] Check `currentTenantId` is not null before mutation
- [ ] Verify current user has org_admin role before showing create button
- [ ] Validate email format client-side before submission
- [ ] Check password meets requirements

### Task 2: Improve Error Display
- [ ] Parse specific error types (RLS, session, network)
- [ ] Show user-friendly error messages in toast
- [ ] Add error state to form fields for validation errors

### Task 3: Add Loading States
- [ ] Disable form during submission
- [ ] Show spinner on create button
- [ ] Prevent double-submission

### Task 4: Handle Partial Failures
- [ ] If user created but tenant_users fails, show specific message
- [ ] Suggest refreshing page to see if user appears
- [ ] Add "retry" option where appropriate

### Task 5: Apply Same Fixes to AdminTenantDetailPage
- [ ] Mirror all TeamPage improvements
- [ ] Test SysAdmin flow separately

## Implementation

### TeamPage.tsx Changes

```typescript
// Add validation before mutation
const handleCreateUser = async (data: CreateUserFormData) => {
  // Pre-flight checks
  if (!currentTenantId) {
    toast.error('No tenant selected. Please refresh and try again.')
    return
  }

  if (!userRole || userRole !== 'org_admin') {
    toast.error('You do not have permission to create users.')
    return
  }

  // Email validation
  if (!isValidEmail(data.email)) {
    toast.error('Please enter a valid email address.')
    return
  }

  // Password validation
  const passwordResult = validatePasswordStrength(data.password)
  if (!passwordResult.isValid) {
    toast.error(passwordResult.message)
    return
  }

  try {
    await createUserMutation.mutateAsync(data)
    toast.success('User created successfully')
    setIsCreateDialogOpen(false)
  } catch (error) {
    // Parse error type
    const message = error instanceof Error ? error.message : 'Failed to create user'

    if (message.includes('permission denied')) {
      toast.error('Permission denied. You may not have admin rights for this tenant.')
    } else if (message.includes('session')) {
      toast.error('Session error. Please refresh the page and try again.')
    } else if (message.includes('already exists') || message.includes('duplicate')) {
      toast.error('A user with this email already exists.')
    } else {
      toast.error(message)
    }
  }
}

// Add role check to conditionally show button
const canCreateUsers = userRole === 'org_admin' || userRole === 'sys_admin'

return (
  <>
    {canCreateUsers && (
      <Button onClick={() => setIsCreateDialogOpen(true)}>
        Create User
      </Button>
    )}

    {/* Form with proper disabled states */}
    <Dialog open={isCreateDialogOpen}>
      <form onSubmit={handleSubmit(handleCreateUser)}>
        <Input
          {...register('email')}
          disabled={createUserMutation.isPending}
        />
        {/* ... other fields ... */}
        <Button
          type="submit"
          disabled={createUserMutation.isPending}
        >
          {createUserMutation.isPending ? (
            <>
              <Spinner className="mr-2" />
              Creating...
            </>
          ) : (
            'Create User'
          )}
        </Button>
      </form>
    </Dialog>
  </>
)
```

### Error Type Constants

```typescript
// src/lib/errors.ts
export const USER_CREATION_ERRORS = {
  NO_TENANT: 'No tenant context available',
  NO_PERMISSION: 'You do not have permission to create users',
  INVALID_EMAIL: 'Please enter a valid email address',
  WEAK_PASSWORD: 'Password does not meet requirements',
  EMAIL_EXISTS: 'A user with this email already exists',
  SESSION_ERROR: 'Session error - please refresh and try again',
  RLS_ERROR: 'Permission denied by database policy',
  PARTIAL_FAILURE: 'User created but not added to tenant',
  UNKNOWN: 'An unexpected error occurred',
}

export function parseUserCreationError(error: unknown): string {
  const message = error instanceof Error ? error.message : String(error)

  if (message.includes('permission denied')) return USER_CREATION_ERRORS.RLS_ERROR
  if (message.includes('session')) return USER_CREATION_ERRORS.SESSION_ERROR
  if (message.includes('already exists') || message.includes('duplicate')) {
    return USER_CREATION_ERRORS.EMAIL_EXISTS
  }
  if (message.includes('not added to tenant')) return USER_CREATION_ERRORS.PARTIAL_FAILURE

  return message || USER_CREATION_ERRORS.UNKNOWN
}
```

## Verification

- [ ] Create user with valid data - success toast shown
- [ ] Create user with invalid email - validation error shown
- [ ] Create user as non-admin - button not visible
- [ ] Create user when logged out - session error shown
- [ ] Double-click create - only one request sent
- [ ] Network error - appropriate error message

## Estimated Effort

Small-Medium - 2-3 hours
