# Plan 05-01: Fix RLS Policies for User Creation

**Status:** âœ… COMPLETE (2026-02-16)

## Goal

Ensure RLS policies allow OrgAdmin to create users in their tenant without conflicts.

## Tasks

### Task 1: Audit Current RLS Policies
- [ ] Review all policies on `user_profiles` table
- [ ] Review all policies on `tenant_users` table
- [ ] Identify conflicts between migrations 018 and 025
- [ ] Document current state

### Task 2: Create Consolidated Migration
- [ ] Create `031_fix_user_creation_rls.sql`
- [ ] Drop all existing conflicting policies
- [ ] Create clean, well-documented policies:
  - `user_profiles` INSERT: Allow own profile, sys_admin any, org_admin for tenant members
  - `user_profiles` SELECT: Allow own, same tenant, sys_admin all
  - `tenant_users` INSERT: Allow sys_admin any, org_admin in their tenant
  - `tenant_users` SELECT: Allow same tenant, sys_admin all

### Task 3: Add Helper Functions
- [ ] Create `is_org_admin_of_tenant(tenant_id)` function for cleaner policy checks
- [ ] Ensure `is_sys_admin()` and `is_org_admin()` functions are idempotent

### Task 4: Test Policies
- [ ] Test as OrgAdmin: INSERT into user_profiles
- [ ] Test as OrgAdmin: INSERT into tenant_users
- [ ] Test as SysAdmin: Same operations
- [ ] Test as org_user: Should be denied

## Implementation

```sql
-- Migration 031: Fix User Creation RLS

-- Helper function: Check if user is org_admin of specific tenant
CREATE OR REPLACE FUNCTION public.is_org_admin_of_tenant(p_tenant_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM tenant_users
        WHERE user_id = auth.uid()
        AND tenant_id = p_tenant_id
        AND role = 'org_admin'
        AND status = 'active'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop conflicting policies
DROP POLICY IF EXISTS "user_profiles_insert_policy" ON user_profiles;
DROP POLICY IF EXISTS "user_profiles_tenant_select_policy" ON user_profiles;
DROP POLICY IF EXISTS "org_admin_insert_tenant_users" ON tenant_users;

-- user_profiles INSERT: Self, SysAdmin, or OrgAdmin creating for their tenant
CREATE POLICY "user_profiles_insert_v2" ON user_profiles
    FOR INSERT WITH CHECK (
        -- Users can create their own profile
        auth.uid() = user_id
        -- SysAdmin can create any profile
        OR public.is_sys_admin()
        -- OrgAdmin can create profiles (will be constrained by tenant_users INSERT)
        OR public.is_org_admin()
    );

-- user_profiles SELECT: Self, same tenant members, or SysAdmin
CREATE POLICY "user_profiles_select_v2" ON user_profiles
    FOR SELECT USING (
        user_id = auth.uid()
        OR user_id IN (
            SELECT tu2.user_id
            FROM tenant_users tu1
            JOIN tenant_users tu2 ON tu1.tenant_id = tu2.tenant_id
            WHERE tu1.user_id = auth.uid()
        )
        OR public.is_sys_admin()
    );

-- tenant_users INSERT: SysAdmin any, OrgAdmin in their tenant only
CREATE POLICY "tenant_users_insert_v2" ON tenant_users
    FOR INSERT WITH CHECK (
        public.is_sys_admin()
        OR public.is_org_admin_of_tenant(tenant_id)
    );
```

## Verification

- [ ] Run migration successfully
- [ ] OrgAdmin can create user without RLS error
- [ ] New user visible in team list immediately
- [ ] SysAdmin can create user in any tenant
- [ ] Regular org_user cannot create users

## Estimated Effort

Small - 1-2 hours
