---
phase: 01-foundation-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/api/clients.ts
  - src/hooks/useClients.ts
autonomous: true

must_haves:
  truths:
    - "Client creation includes tenant_id from auth context"
    - "Client creation fails gracefully if tenant_id is missing"
    - "Created clients are visible to users in the same tenant"
  artifacts:
    - path: "src/services/api/clients.ts"
      provides: "Client API with tenant_id injection"
      contains: "tenant_id"
    - path: "src/hooks/useClients.ts"
      provides: "React hooks that pass tenant context"
      exports: ["useClients", "useClientMutations"]
  key_links:
    - from: "src/hooks/useClients.ts"
      to: "src/services/api/clients.ts"
      via: "mutationFn call with tenantId"
      pattern: "clientsApi\\.create\\(tenantId"
    - from: "src/stores/tenantStore.ts"
      to: "src/hooks/useClients.ts"
      via: "useTenantStore"
      pattern: "currentTenant"
---

<objective>
Ensure all client INSERT operations include tenant_id from auth context to prevent RLS visibility bugs.

Purpose: Without explicit tenant_id, created records may not be visible due to RLS policies. This fix ensures tenant isolation is properly maintained.

Output: Updated API and hooks that guarantee tenant_id is always included in INSERT operations.
</objective>

<execution_context>
@/Users/ayazmohammed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ayazmohammed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/api/clients.ts
@src/hooks/useClients.ts
@src/stores/tenantStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenant_id validation in useClientMutations</name>
  <files>src/hooks/useClients.ts</files>
  <action>
Update the `useClientMutations` hook in src/hooks/useClients.ts to:

1. Add validation that throws an error if `tenantId` is null/undefined before calling the mutation
2. Keep existing toast notifications for error handling
3. Add TypeScript assertion to guarantee tenantId is defined when mutation runs

Current code passes `tenantId!` which assumes it's always defined. Instead:
- Check if tenantId exists before calling mutateAsync
- Throw a clear error message if missing: "Cannot create client: No tenant selected"

The mutation function should look like:
```typescript
const createClient = useMutation({
  mutationFn: (input: CreateClientInput) => {
    if (!tenantId) {
      throw new Error('Cannot create client: No tenant selected')
    }
    if (!user?.id) {
      throw new Error('Cannot create client: User not authenticated')
    }
    return clientsApi.create(tenantId, user.id, input)
  },
  // ... rest of mutation config
})
```

This ensures the mutation fails fast with a clear error instead of silently creating orphaned records.
  </action>
  <verify>
Read src/hooks/useClients.ts and verify:
- tenantId is checked before API call
- user?.id is checked before API call
- Clear error messages for missing context
  </verify>
  <done>
createClient mutation validates tenantId and userId exist before API call, with clear error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify clientsApi.create includes tenant_id in INSERT</name>
  <files>src/services/api/clients.ts</files>
  <action>
Review and confirm src/services/api/clients.ts `create` function:

1. Verify tenant_id is included in the INSERT object (currently on line 89)
2. Verify created_by is included (currently on line 90)
3. Ensure no fields can be inserted without tenant_id

The current implementation already includes tenant_id in the insert. This task confirms the pattern is correct and adds a comment documenting the tenant isolation requirement:

Add a comment above the insert:
```typescript
// IMPORTANT: Always include tenant_id for RLS visibility
// Records without tenant_id will not be visible to users
```

No functional changes needed - this is verification and documentation.
  </action>
  <verify>
Read src/services/api/clients.ts and verify:
- tenant_id is in the insert object
- Comment documents the requirement
  </verify>
  <done>
clientsApi.create explicitly includes tenant_id with documentation explaining RLS requirement.
  </done>
</task>

</tasks>

<verification>
1. src/hooks/useClients.ts has validation for tenantId before mutation
2. src/services/api/clients.ts includes tenant_id in INSERT
3. Error messages are user-friendly
4. TypeScript compiles without errors: `npm run build`
</verification>

<success_criteria>
- Client creation validates tenant context before API call
- Missing tenant_id produces clear error message
- BUG-02 is resolved: tenant isolation is enforced at the application layer
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-02-SUMMARY.md`
</output>
