# Plan 07-02: Client Portal Enhancement

## Goal

Expand the client portal to show sets, requirements, and documents to client users, enabling better transparency and collaboration.

## Current State

- **PortalDashboardPage:** Shows projects filtered by `show_in_client_portal`
- **PortalProjectPage:** Basic project view with minimal info
- **Client User Role:** `client_user` role exists, linked to specific client via `client_users` table
- **RLS:** Policies exist but may need enhancement for portal access

## Tasks

### Task 1: Enhance PortalProjectPage
- [ ] Add Sets tab showing client-visible sets
- [ ] Add Requirements tab showing client-visible requirements
- [ ] Add Documents tab showing portal-visible documents
- [ ] Add Status Updates section (client-visible only)
- [ ] Remove edit capabilities (read-only)

### Task 2: Add Portal Visibility Flags
- [ ] Verify `show_in_client_portal` on sets table (add if missing)
- [ ] Verify `show_in_client_portal` on requirements table (add if missing)
- [ ] Create migration if needed

### Task 3: Create Portal-Specific Components
- [ ] `PortalSetsTable` - Read-only sets view
- [ ] `PortalRequirementsTable` - Read-only requirements view
- [ ] `PortalDocumentsGrid` - Documents with download only
- [ ] `PortalStatusTimeline` - Client-visible updates only

### Task 4: Update RLS Policies
- [ ] `client_user` can SELECT projects where `show_in_client_portal = true` AND linked via `client_users.client_id`
- [ ] `client_user` can SELECT sets where `show_in_client_portal = true` AND linked to visible project
- [ ] `client_user` can SELECT requirements where `show_in_client_portal = true`
- [ ] `client_user` can SELECT documents where `show_in_portal = true`

### Task 5: Add Set/Requirement Detail Pages for Portal
- [ ] `PortalSetDetailPage` - Read-only set view
- [ ] `PortalRequirementDetailPage` - Read-only requirement view
- [ ] Navigation from portal tables to detail pages

## Implementation

### Migration: Add Portal Visibility Flags

```sql
-- Migration 032: Portal visibility flags

-- Add show_in_client_portal to sets if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'sets' AND column_name = 'show_in_client_portal'
    ) THEN
        ALTER TABLE sets ADD COLUMN show_in_client_portal BOOLEAN DEFAULT false;
    END IF;
END $$;

-- Add show_in_client_portal to requirements if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'requirements' AND column_name = 'show_in_client_portal'
    ) THEN
        ALTER TABLE requirements ADD COLUMN show_in_client_portal BOOLEAN DEFAULT false;
    END IF;
END $$;

-- RLS for client_user access to sets
CREATE POLICY "client_user_select_portal_sets" ON sets
    FOR SELECT USING (
        show_in_client_portal = true
        AND client_id IN (
            SELECT cu.client_id FROM client_users cu
            WHERE cu.user_id = auth.uid()
        )
    );

-- RLS for client_user access to requirements
CREATE POLICY "client_user_select_portal_requirements" ON requirements
    FOR SELECT USING (
        show_in_client_portal = true
        AND set_id IN (
            SELECT s.id FROM sets s
            WHERE s.show_in_client_portal = true
            AND s.client_id IN (
                SELECT cu.client_id FROM client_users cu
                WHERE cu.user_id = auth.uid()
            )
        )
    );
```

### Enhanced PortalProjectPage.tsx

```typescript
export function PortalProjectPage() {
  const { projectId } = useParams()
  const { data: project, isLoading } = useProjectById(projectId!)
  const { data: sets } = usePortalSets(projectId!)
  const { data: requirements } = usePortalRequirements(projectId!)
  const { data: documents } = usePortalDocuments(projectId!)
  const { data: statusUpdates } = usePortalStatusUpdates(projectId!)

  if (isLoading) return <PageSkeleton />
  if (!project) return <NotFound />

  return (
    <PortalLayout>
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold">{project.name}</h1>
        <p className="text-muted-foreground">{project.description}</p>
        <div className="flex items-center gap-4 mt-2">
          <Badge>{project.status}</Badge>
          <span className="text-sm">
            Health: <Badge variant={getHealthVariant(project.health)}>{project.health}</Badge>
          </span>
          <span className="text-sm">
            Progress: {project.completion_percentage}%
          </span>
        </div>
      </div>

      {/* Status Updates (if any) */}
      {statusUpdates && statusUpdates.length > 0 && (
        <Card className="mb-6">
          <CardHeader>
            <CardTitle>Recent Updates</CardTitle>
          </CardHeader>
          <CardContent>
            <PortalStatusTimeline updates={statusUpdates.slice(0, 3)} />
            {statusUpdates.length > 3 && (
              <Button variant="link" className="mt-2">
                View all {statusUpdates.length} updates
              </Button>
            )}
          </CardContent>
        </Card>
      )}

      {/* Tabs */}
      <Tabs defaultValue="overview">
        <TabsList>
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="sets">Work Packages ({sets?.length || 0})</TabsTrigger>
          <TabsTrigger value="requirements">Items ({requirements?.length || 0})</TabsTrigger>
          <TabsTrigger value="documents">Documents ({documents?.length || 0})</TabsTrigger>
        </TabsList>

        <TabsContent value="overview">
          <PortalProjectOverview project={project} />
        </TabsContent>

        <TabsContent value="sets">
          <PortalSetsTable sets={sets || []} />
        </TabsContent>

        <TabsContent value="requirements">
          <PortalRequirementsTable requirements={requirements || []} />
        </TabsContent>

        <TabsContent value="documents">
          <PortalDocumentsGrid documents={documents || []} />
        </TabsContent>
      </Tabs>
    </PortalLayout>
  )
}
```

### PortalSetsTable Component

```typescript
export function PortalSetsTable({ sets }: { sets: Set[] }) {
  const navigate = useNavigate()

  const columns: ColumnDef<Set>[] = [
    {
      accessorKey: 'display_id',
      header: 'ID',
      cell: ({ row }) => (
        <span className="font-mono text-sm">{row.original.display_id}</span>
      ),
    },
    {
      accessorKey: 'name',
      header: 'Name',
    },
    {
      accessorKey: 'status',
      header: 'Status',
      cell: ({ row }) => <Badge>{row.original.status}</Badge>,
    },
    {
      accessorKey: 'expected_end_date',
      header: 'Expected Completion',
      cell: ({ row }) =>
        row.original.expected_end_date
          ? format(new Date(row.original.expected_end_date), 'MMM d, yyyy')
          : '-',
    },
    {
      id: 'progress',
      header: 'Progress',
      cell: ({ row }) => (
        <Progress value={row.original.completion_percentage || 0} className="w-20" />
      ),
    },
  ]

  return (
    <Card>
      <CardContent className="pt-6">
        {sets.length === 0 ? (
          <p className="text-center text-muted-foreground py-8">
            No work packages are currently shared with you.
          </p>
        ) : (
          <DataTable
            columns={columns}
            data={sets}
            onRowClick={(row) => navigate(`/portal/sets/${row.id}`)}
          />
        )}
      </CardContent>
    </Card>
  )
}
```

### PortalDocumentsGrid Component

```typescript
export function PortalDocumentsGrid({ documents }: { documents: Document[] }) {
  const handleDownload = async (doc: Document) => {
    if (!doc.file_url) return
    const url = await documentsApi.getSignedUrl(doc.file_url)
    window.open(url, '_blank')
  }

  return (
    <Card>
      <CardContent className="pt-6">
        {documents.length === 0 ? (
          <p className="text-center text-muted-foreground py-8">
            No documents are currently shared with you.
          </p>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {documents.map(doc => (
              <Card key={doc.id} className="p-4 hover:bg-muted/50 cursor-pointer"
                onClick={() => handleDownload(doc)}>
                <div className="flex flex-col items-center text-center">
                  <FileIcon fileType={doc.file_type} className="h-12 w-12 mb-2" />
                  <span className="font-medium truncate w-full">{doc.name}</span>
                  <span className="text-sm text-muted-foreground">
                    {doc.file_type || 'Document'}
                  </span>
                  <Button variant="ghost" size="sm" className="mt-2">
                    <Download className="h-4 w-4 mr-1" />
                    Download
                  </Button>
                </div>
              </Card>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Portal Hooks

```typescript
// src/hooks/usePortal.ts

export function usePortalSets(projectId: string) {
  return useQuery({
    queryKey: ['portal', 'sets', projectId],
    queryFn: () => setsApi.getPortalVisible(projectId),
    enabled: !!projectId,
  })
}

export function usePortalRequirements(projectId: string) {
  return useQuery({
    queryKey: ['portal', 'requirements', projectId],
    queryFn: () => requirementsApi.getPortalVisible(projectId),
    enabled: !!projectId,
  })
}

export function usePortalDocuments(projectId: string) {
  return useQuery({
    queryKey: ['portal', 'documents', projectId],
    queryFn: () => documentsApi.getPortalVisible(projectId),
    enabled: !!projectId,
  })
}

export function usePortalStatusUpdates(projectId: string) {
  return useQuery({
    queryKey: ['portal', 'status-updates', projectId],
    queryFn: () => statusUpdatesApi.getClientVisible(projectId),
    enabled: !!projectId,
  })
}
```

## Files to Create/Modify

### New Files
- `supabase/migrations/032_portal_visibility.sql`
- `src/pages/portal/PortalSetDetailPage.tsx`
- `src/pages/portal/PortalRequirementDetailPage.tsx`
- `src/components/portal/PortalSetsTable.tsx`
- `src/components/portal/PortalRequirementsTable.tsx`
- `src/components/portal/PortalDocumentsGrid.tsx`
- `src/components/portal/PortalStatusTimeline.tsx`
- `src/hooks/usePortal.ts`

### Modified Files
- `src/pages/portal/PortalProjectPage.tsx`
- `src/services/api/sets.ts` - Add `getPortalVisible`
- `src/services/api/requirements.ts` - Add `getPortalVisible`
- `src/services/api/documents.ts` - Add `getPortalVisible`
- `src/App.tsx` - Add portal routes

## Verification

- [ ] Client user can see portal-visible sets
- [ ] Client user can see portal-visible requirements
- [ ] Client user can download portal-visible documents
- [ ] Client user sees only client-visible status updates
- [ ] Client user cannot edit anything (read-only)
- [ ] Portal visibility toggles work in main app
- [ ] RLS prevents access to non-portal items

## Estimated Effort

Large - 8-10 hours
