# Plan 07-01: Phase Management UI

## Goal

Build comprehensive UI for managing project phases including overview page, detail page, and drag-drop ordering.

## Current State

- **Database:** `project_phases` table with all necessary fields:
  - `id`, `tenant_id`, `project_id`
  - `name`, `description`, `status`
  - `phase_id_display` (auto-generated PH-XXXX)
  - `lead_id`, `secondary_lead_id`
  - `order_key`, `predecessor_phase_id`, `successor_phase_id`
  - `expected_start_date`, `expected_end_date`, `actual_start_date`, `actual_end_date`
  - `urgency`, `importance`, `priority`
  - `is_template`
- **API:** `phasesApi` exists with CRUD operations
- **Hooks:** `usePhases`, `usePhasesByProject` exist
- **UI:** Basic phases tab in ProjectDetailPage (table only)

## Tasks

### Task 1: Create PhasesPage (Overview)
- [ ] Create `src/pages/phases/PhasesPage.tsx`
- [ ] Add route `/phases` to App.tsx
- [ ] Add to sidebar navigation
- [ ] Data grid with columns: Project, Phase Name, Status, Lead, Dates, Progress
- [ ] Filtering by project, status
- [ ] Click to navigate to PhaseDetailPage
- [ ] Double-click to navigate

### Task 2: Create PhaseDetailPage
- [ ] Create `src/pages/phases/PhaseDetailPage.tsx`
- [ ] Add route `/phases/:phaseId` to App.tsx
- [ ] Header with breadcrumbs: Project > Phase Name
- [ ] ViewEditField components for all editable fields
- [ ] Tabs: Details, Sets
- [ ] Team assignment dropdowns (Lead, Secondary Lead)
- [ ] Schedule section with date pickers
- [ ] Priority section with Eisenhower matrix display

### Task 3: Enhance Phases Tab in ProjectDetailPage
- [ ] Add "Create Phase" button
- [ ] Add inline phase creation form
- [ ] Add phase ordering indicators
- [ ] Add edit/delete actions per row

### Task 4: Implement Drag-Drop Phase Ordering
- [ ] Install `@dnd-kit/core` and `@dnd-kit/sortable` if not present
- [ ] Create DraggablePhasesTable component
- [ ] Update `order_key` on drag end
- [ ] Visual feedback during drag
- [ ] Persist order to database

### Task 5: Create PhaseForm Component
- [ ] Create `src/components/phases/PhaseForm.tsx`
- [ ] Fields: Name, Description, Status, Lead, Secondary Lead
- [ ] Date fields: Expected Start, Expected End
- [ ] Priority fields: Urgency, Importance (auto-calculates priority)

## Implementation

### PhasesPage.tsx

```typescript
export function PhasesPage() {
  const { currentTenantId } = useTenant()
  const { data: phases, isLoading } = usePhases(currentTenantId)
  const navigate = useNavigate()

  const columns: ColumnDef<Phase>[] = [
    {
      accessorKey: 'phase_id_display',
      header: 'ID',
      cell: ({ row }) => (
        <span className="font-mono text-sm">{row.original.phase_id_display}</span>
      ),
    },
    {
      accessorKey: 'project.name',
      header: 'Project',
      cell: ({ row }) => (
        <Link to={`/projects/${row.original.project_id}`} className="hover:underline">
          {row.original.project?.name}
        </Link>
      ),
    },
    {
      accessorKey: 'name',
      header: 'Phase Name',
    },
    {
      accessorKey: 'status',
      header: 'Status',
      cell: ({ row }) => <Badge>{row.original.status}</Badge>,
    },
    {
      accessorKey: 'lead.full_name',
      header: 'Lead',
      cell: ({ row }) => row.original.lead?.full_name || '-',
    },
    {
      accessorKey: 'expected_end_date',
      header: 'Due Date',
      cell: ({ row }) =>
        row.original.expected_end_date
          ? format(new Date(row.original.expected_end_date), 'MMM d, yyyy')
          : '-',
    },
  ]

  return (
    <PageLayout>
      <PageHeader
        title="Phases"
        description="Manage project phases across all projects"
      />

      <DataTable
        columns={columns}
        data={phases || []}
        isLoading={isLoading}
        onRowClick={(row) => navigate(`/phases/${row.id}`)}
        onRowDoubleClick={(row) => navigate(`/phases/${row.id}`)}
      />
    </PageLayout>
  )
}
```

### PhaseDetailPage.tsx

```typescript
export function PhaseDetailPage() {
  const { phaseId } = useParams()
  const { data: phase, isLoading } = usePhaseById(phaseId!)
  const { updatePhase } = usePhaseMutations()
  const [isEditMode, setIsEditMode] = useState(false)
  const [formData, setFormData] = useState<Partial<Phase>>({})

  useEffect(() => {
    if (phase) setFormData(phase)
  }, [phase])

  const handleSave = async () => {
    await updatePhase.mutateAsync({ id: phaseId!, data: formData })
    setIsEditMode(false)
  }

  if (isLoading) return <PageSkeleton />
  if (!phase) return <NotFound />

  return (
    <PageLayout>
      {/* Breadcrumbs */}
      <Breadcrumb>
        <BreadcrumbItem>
          <Link to={`/projects/${phase.project_id}`}>
            {phase.project?.name}
          </Link>
        </BreadcrumbItem>
        <BreadcrumbItem>{phase.name}</BreadcrumbItem>
      </Breadcrumb>

      {/* Header */}
      <PageHeader
        title={phase.name}
        subtitle={phase.phase_id_display}
        actions={
          isEditMode ? (
            <>
              <Button variant="outline" onClick={() => setIsEditMode(false)}>Cancel</Button>
              <Button onClick={handleSave}>Save</Button>
            </>
          ) : (
            <Button onClick={() => setIsEditMode(true)}>Edit</Button>
          )
        }
      />

      <Tabs defaultValue="details">
        <TabsList>
          <TabsTrigger value="details">Details</TabsTrigger>
          <TabsTrigger value="sets">Sets</TabsTrigger>
        </TabsList>

        <TabsContent value="details">
          <div className="grid grid-cols-2 gap-6">
            {/* Basic Info */}
            <Card>
              <CardHeader>
                <CardTitle>Phase Information</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <ViewEditField
                  label="Name"
                  value={formData.name}
                  onChange={(v) => setFormData({...formData, name: v})}
                  isEditMode={isEditMode}
                  required
                />
                <ViewEditField
                  label="Description"
                  value={formData.description}
                  onChange={(v) => setFormData({...formData, description: v})}
                  isEditMode={isEditMode}
                  type="textarea"
                />
                <ViewEditField
                  label="Status"
                  value={formData.status}
                  onChange={(v) => setFormData({...formData, status: v})}
                  isEditMode={isEditMode}
                  type="select"
                  options={PHASE_STATUS_OPTIONS}
                />
              </CardContent>
            </Card>

            {/* Team */}
            <Card>
              <CardHeader>
                <CardTitle>Team</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <ViewEditField
                  label="Lead"
                  value={formData.lead_id}
                  onChange={(v) => setFormData({...formData, lead_id: v})}
                  isEditMode={isEditMode}
                  type="select"
                  options={teamOptions}
                  searchable
                />
                <ViewEditField
                  label="Secondary Lead"
                  value={formData.secondary_lead_id}
                  onChange={(v) => setFormData({...formData, secondary_lead_id: v})}
                  isEditMode={isEditMode}
                  type="select"
                  options={teamOptions}
                  searchable
                  clearable
                />
              </CardContent>
            </Card>

            {/* Schedule */}
            <Card>
              <CardHeader>
                <CardTitle>Schedule</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <ViewEditField
                  label="Expected Start"
                  value={formData.expected_start_date}
                  onChange={(v) => setFormData({...formData, expected_start_date: v})}
                  isEditMode={isEditMode}
                  type="date"
                />
                <ViewEditField
                  label="Expected End"
                  value={formData.expected_end_date}
                  onChange={(v) => setFormData({...formData, expected_end_date: v})}
                  isEditMode={isEditMode}
                  type="date"
                />
              </CardContent>
            </Card>

            {/* Priority */}
            <Card>
              <CardHeader>
                <CardTitle>Priority</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <ViewEditField
                  label="Urgency"
                  value={formData.urgency}
                  onChange={(v) => setFormData({...formData, urgency: v})}
                  isEditMode={isEditMode}
                  type="select"
                  options={URGENCY_OPTIONS}
                />
                <ViewEditField
                  label="Importance"
                  value={formData.importance}
                  onChange={(v) => setFormData({...formData, importance: v})}
                  isEditMode={isEditMode}
                  type="select"
                  options={IMPORTANCE_OPTIONS}
                />
                <div>
                  <Label>Calculated Priority</Label>
                  <PriorityBadge priority={formData.priority || phase.priority} />
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        <TabsContent value="sets">
          <SetsByPhaseTable phaseId={phaseId!} />
        </TabsContent>
      </Tabs>

      <AuditTrail record={phase} />
    </PageLayout>
  )
}
```

### DraggablePhasesTable Component

```typescript
import { DndContext, closestCenter } from '@dnd-kit/core'
import { SortableContext, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'

export function DraggablePhasesTable({ projectId }: { projectId: string }) {
  const { data: phases } = usePhasesByProject(projectId)
  const { updatePhase } = usePhaseMutations()

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event
    if (!over || active.id === over.id) return

    const oldIndex = phases.findIndex(p => p.id === active.id)
    const newIndex = phases.findIndex(p => p.id === over.id)

    // Calculate new order_key
    const newOrderKey = calculateOrderKey(phases, oldIndex, newIndex)

    await updatePhase.mutateAsync({
      id: active.id as string,
      data: { order_key: newOrderKey },
    })
  }

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={phases.map(p => p.id)} strategy={verticalListSortingStrategy}>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-8"></TableHead>
              <TableHead>Name</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>Lead</TableHead>
              <TableHead>Due Date</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {phases.map(phase => (
              <SortablePhaseRow key={phase.id} phase={phase} />
            ))}
          </TableBody>
        </Table>
      </SortableContext>
    </DndContext>
  )
}

function SortablePhaseRow({ phase }: { phase: Phase }) {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({
    id: phase.id,
  })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  return (
    <TableRow ref={setNodeRef} style={style}>
      <TableCell>
        <GripVertical className="h-4 w-4 cursor-grab" {...attributes} {...listeners} />
      </TableCell>
      <TableCell>{phase.name}</TableCell>
      <TableCell><Badge>{phase.status}</Badge></TableCell>
      <TableCell>{phase.lead?.full_name || '-'}</TableCell>
      <TableCell>
        {phase.expected_end_date
          ? format(new Date(phase.expected_end_date), 'MMM d')
          : '-'}
      </TableCell>
    </TableRow>
  )
}
```

## Files to Create/Modify

### New Files
- `src/pages/phases/PhasesPage.tsx`
- `src/pages/phases/PhaseDetailPage.tsx`
- `src/components/phases/PhaseForm.tsx`
- `src/components/phases/DraggablePhasesTable.tsx`

### Modified Files
- `src/App.tsx` - Add routes
- `src/components/layout/Sidebar.tsx` - Add navigation
- `src/pages/projects/ProjectDetailPage.tsx` - Update Phases tab

## Verification

- [ ] PhasesPage shows all phases with project info
- [ ] PhaseDetailPage loads and shows all phase fields
- [ ] Can edit phase details in edit mode
- [ ] Team dropdowns work correctly
- [ ] Drag-drop reorders phases
- [ ] Order persists after page refresh
- [ ] Sets tab shows sets for this phase

## Estimated Effort

Medium-Large - 6-8 hours
