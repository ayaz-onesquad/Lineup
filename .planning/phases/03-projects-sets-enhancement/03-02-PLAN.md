---
phase: 03-projects-sets-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/019_sets_budget_fields.sql
  - src/types/database.ts
  - src/pages/sets/SetDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Sets have budget_days and budget_hours columns in database"
    - "SetDetailPage displays Budget Days and Budget Hours fields"
    - "Budget fields are editable in Edit Mode and persist to database"
  artifacts:
    - path: "supabase/migrations/019_sets_budget_fields.sql"
      provides: "Database schema for budget fields"
      contains: "budget_days"
    - path: "src/types/database.ts"
      provides: "TypeScript types for budget fields"
      contains: "budget_days"
    - path: "src/pages/sets/SetDetailPage.tsx"
      provides: "Budget field UI in Set Detail"
      contains: "budget_hours"
  key_links:
    - from: "src/pages/sets/SetDetailPage.tsx"
      to: "updateSet.mutateAsync"
      via: "form submission with budget_days, budget_hours"
      pattern: "budget_days|budget_hours"
---

<objective>
Add budget tracking fields to Sets.

Purpose: Sets need budget_days (numeric) and budget_hours (numeric) fields to track effort allocation. This satisfies requirement SET-02 (Sets have Budget Days and Budget Hours fields). The schema and UI both need updates since these fields do not exist in the codebase.

Output: Sets table has budget_days and budget_hours columns, TypeScript types updated, SetDetailPage shows editable budget fields.
</objective>

<execution_context>
@/Users/ayazmohammed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ayazmohammed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.ts
@src/pages/sets/SetDetailPage.tsx
@src/services/api/sets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for budget fields on sets table</name>
  <files>supabase/migrations/019_sets_budget_fields.sql</files>
  <action>
Create a new migration file to add budget_days and budget_hours columns to the sets table:

```sql
-- Migration: Add budget fields to sets table
-- Phase 3 - SET-02: Sets have Budget Days and Budget Hours fields

-- Add budget_days column (INTEGER for whole days)
ALTER TABLE sets ADD COLUMN IF NOT EXISTS budget_days INTEGER;

-- Add budget_hours column (DECIMAL for fractional hours, e.g., 2.5 hours)
ALTER TABLE sets ADD COLUMN IF NOT EXISTS budget_hours DECIMAL(6,2);

-- Add comments for documentation
COMMENT ON COLUMN sets.budget_days IS 'Budgeted number of days for this set';
COMMENT ON COLUMN sets.budget_hours IS 'Budgeted number of hours for this set';

-- Verify columns exist
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'sets' AND column_name IN ('budget_days', 'budget_hours');
```

Note: User will need to run this migration in Supabase SQL Editor, then refresh the schema cache.
  </action>
  <verify>
Migration file exists at supabase/migrations/019_sets_budget_fields.sql with correct SQL syntax.
  </verify>
  <done>
Migration file created with budget_days (INTEGER) and budget_hours (DECIMAL) columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and SetDetailPage form</name>
  <files>src/types/database.ts, src/pages/sets/SetDetailPage.tsx</files>
  <action>
1. Update src/types/database.ts - Add budget fields to Set interface (around line 266-283):

In the Set interface, add after `actual_end_date`:
```typescript
  budget_days?: number
  budget_hours?: number
```

Also update CreateSetInput (around line 545-560) to include:
```typescript
  budget_days?: number
  budget_hours?: number
```

And UpdateSetInput (around line 562-567) already extends CreateSetInput, so it will get the fields automatically.

2. Update src/pages/sets/SetDetailPage.tsx:

a. Add budget fields to setFormSchema (lines 58-74):
```typescript
const setFormSchema = z.object({
  // existing fields...
  budget_days: z.number().optional(),
  budget_hours: z.number().optional(),
})
```

b. Add to form defaultValues (lines 99-114):
```typescript
defaultValues: {
  // existing fields...
  budget_days: set?.budget_days || undefined,
  budget_hours: set?.budget_hours || undefined,
}
```

c. Add to form.reset useEffect (lines 152-170):
```typescript
form.reset({
  // existing fields...
  budget_days: set.budget_days || undefined,
  budget_hours: set.budget_hours || undefined,
})
```

d. Add to handleSaveSet mutation call (lines 182-207):
```typescript
await updateSet.mutateAsync({
  // existing fields...
  budget_days: data.budget_days,
  budget_hours: data.budget_hours,
})
```

e. Add to handleCancelEdit form reset (lines 209-227):
```typescript
form.reset({
  // existing fields...
  budget_days: set?.budget_days || undefined,
  budget_hours: set?.budget_hours || undefined,
})
```

f. Add Budget Section to Details tab (after Schedule section, around line 572). Add the Wallet icon import at the top, then add:

Add to imports at top of file:
```typescript
import { Wallet } from 'lucide-react'
```

Add Budget section after Schedule section:
```tsx
{/* Budget Section */}
<Card className="card-carbon">
  <CardContent className="pt-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <Wallet className="h-5 w-5 text-muted-foreground" />
      Budget
    </h3>
    <div className="grid grid-cols-2 gap-6">
      <div>
        <p className="text-sm font-medium text-muted-foreground mb-1">Budget Days</p>
        {isEditing ? (
          <input
            type="number"
            className="w-full px-3 py-2 border rounded-md text-sm"
            value={form.watch('budget_days') ?? ''}
            onChange={(e) => form.setValue('budget_days', e.target.value ? Number(e.target.value) : undefined)}
            placeholder="0"
            min="0"
            step="1"
          />
        ) : (
          <p className="font-medium">{set.budget_days ?? '—'}</p>
        )}
      </div>
      <div>
        <p className="text-sm font-medium text-muted-foreground mb-1">Budget Hours</p>
        {isEditing ? (
          <input
            type="number"
            className="w-full px-3 py-2 border rounded-md text-sm"
            value={form.watch('budget_hours') ?? ''}
            onChange={(e) => form.setValue('budget_hours', e.target.value ? Number(e.target.value) : undefined)}
            placeholder="0.00"
            min="0"
            step="0.25"
          />
        ) : (
          <p className="font-medium">{set.budget_hours ?? '—'}</p>
        )}
      </div>
    </div>
  </CardContent>
</Card>
```
  </action>
  <verify>
1. Run `npm run build` - should complete without TypeScript errors
2. Verify budget fields appear in Set interface and CreateSetInput in database.ts
  </verify>
  <done>
TypeScript types include budget_days and budget_hours. SetDetailPage form schema includes budget fields. Budget UI section added to Details tab.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct SQL
2. `npm run build` passes without TypeScript errors
3. Set interface in database.ts includes budget_days and budget_hours
4. SetDetailPage shows Budget section with two number inputs
5. After running migration, budget values persist when editing a Set
</verification>

<success_criteria>
- sets table has budget_days (INTEGER) and budget_hours (DECIMAL) columns
- TypeScript types updated for Set, CreateSetInput, UpdateSetInput
- SetDetailPage shows Budget section with editable number inputs
- Budget values save and load correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-projects-sets-enhancement/03-02-SUMMARY.md`

Note: User must run migration in Supabase SQL Editor before budget fields will persist:
1. Open Supabase Dashboard -> SQL Editor
2. Run contents of supabase/migrations/019_sets_budget_fields.sql
3. Run supabase/refresh-schema-cache.sql to refresh PostgREST cache
</output>
