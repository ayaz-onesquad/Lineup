---
phase: 03-projects-sets-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/projects/ProjectDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Projects have Lead, Secondary Lead, and PM dropdowns editable in Edit Mode"
    - "Selecting a team member from dropdown persists to database on save"
    - "Team member avatars/initials display correctly in View Mode"
  artifacts:
    - path: "src/pages/projects/ProjectDetailPage.tsx"
      provides: "Editable team member dropdowns in Project Detail"
      contains: "SearchableSelect"
  key_links:
    - from: "src/pages/projects/ProjectDetailPage.tsx"
      to: "projectsApi.update"
      via: "updateProject.mutateAsync with lead_id, secondary_lead_id, pm_id"
      pattern: "updateProject\\.mutateAsync.*lead_id"
---

<objective>
Add editable team member dropdowns to ProjectDetailPage.

Purpose: Currently the Team section on ProjectDetailPage only DISPLAYS team members but does not allow editing them in Edit Mode. SetDetailPage already has this pattern implemented - we need to replicate it for Projects to satisfy PROJ-03 (Projects have Lead, Secondary Lead, and PM dropdowns) and UI-05 (Parent relationships editable via searchable dropdowns).

Output: ProjectDetailPage Team section with SearchableSelect dropdowns for Lead, Secondary Lead, and PM that work in Edit Mode.
</objective>

<execution_context>
@/Users/ayazmohammed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ayazmohammed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/projects/ProjectDetailPage.tsx
@src/pages/sets/SetDetailPage.tsx (reference for team dropdown pattern)
@src/hooks/useTenant.ts (useTenantUsers hook)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add team member fields to project form schema and state</name>
  <files>src/pages/projects/ProjectDetailPage.tsx</files>
  <action>
Update ProjectDetailPage to support editable team member dropdowns:

1. Add team fields to projectFormSchema (lines ~56-65):
```typescript
const projectFormSchema = z.object({
  // existing fields...
  lead_id: z.string().optional(),
  secondary_lead_id: z.string().optional(),
  pm_id: z.string().optional(),
})
```

2. Add import for useTenantUsers hook:
```typescript
import { useTenantUsers } from '@/hooks/useTenant'
```

3. Add import for SearchableSelect:
```typescript
import { SearchableSelect } from '@/components/ui/searchable-select'
```

4. Inside the component, add tenant users query (after line ~76):
```typescript
const { data: users } = useTenantUsers()
```

5. Add userOptions memo (similar to SetDetailPage pattern at lines 143-149):
```typescript
const userOptions = useMemo(() =>
  users?.filter((u) => u.user_profiles?.id).map((u) => ({
    value: u.user_profiles!.id,
    label: u.user_profiles?.full_name || 'Unknown',
  })) || [],
  [users]
)
```

6. Add useMemo import if not present:
```typescript
import { useState, useEffect, useMemo } from 'react'
```

7. Update form defaultValues (lines ~90-99) to include team fields:
```typescript
defaultValues: {
  // existing fields...
  lead_id: project?.lead_id || '',
  secondary_lead_id: project?.secondary_lead_id || '',
  pm_id: project?.pm_id || '',
}
```

8. Update form.reset in useEffect (lines ~103-116) to include team fields:
```typescript
form.reset({
  // existing fields...
  lead_id: project.lead_id || '',
  secondary_lead_id: project.secondary_lead_id || '',
  pm_id: project.pm_id || '',
})
```

9. Update handleSaveProject (lines ~147-166) to include team fields:
```typescript
await updateProject.mutateAsync({
  id: projectId,
  // existing fields...
  lead_id: data.lead_id || undefined,
  secondary_lead_id: data.secondary_lead_id || undefined,
  pm_id: data.pm_id || undefined,
})
```

10. Update handleCancelEdit (lines ~168-180) to include team fields in reset.
  </action>
  <verify>
Run `npm run build` - should complete without TypeScript errors.
  </verify>
  <done>
Form schema and state management includes lead_id, secondary_lead_id, pm_id fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace static Team section with editable dropdowns</name>
  <files>src/pages/projects/ProjectDetailPage.tsx</files>
  <action>
Replace the Team section (lines ~736-798) with the editable pattern from SetDetailPage:

1. Replace the entire Team section Card with this pattern:
```tsx
{/* Team Section - Editable dropdowns in Edit Mode */}
<Card className="card-carbon">
  <CardContent className="pt-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <Users className="h-5 w-5 text-muted-foreground" />
      Team
    </h3>
    <div className="grid grid-cols-3 gap-6">
      {/* Lead */}
      <div>
        <p className="text-sm font-medium text-muted-foreground mb-1">Lead</p>
        {isEditing ? (
          <SearchableSelect
            options={userOptions}
            value={form.watch('lead_id') || ''}
            onValueChange={(value) => form.setValue('lead_id', value || '')}
            placeholder="Select lead..."
            searchPlaceholder="Search team..."
            emptyMessage="No team members found."
            clearable
          />
        ) : project.lead ? (
          <div className="flex items-center gap-2">
            <div className="h-8 w-8 rounded-full bg-muted flex items-center justify-center">
              <span className="text-xs font-medium">
                {project.lead.full_name?.split(' ').map(n => n[0]).join('')}
              </span>
            </div>
            <span className="font-medium">{project.lead.full_name}</span>
          </div>
        ) : (
          <p className="text-muted-foreground">—</p>
        )}
      </div>

      {/* Secondary Lead */}
      <div>
        <p className="text-sm font-medium text-muted-foreground mb-1">Secondary Lead</p>
        {isEditing ? (
          <SearchableSelect
            options={userOptions}
            value={form.watch('secondary_lead_id') || ''}
            onValueChange={(value) => form.setValue('secondary_lead_id', value || '')}
            placeholder="Select secondary lead..."
            searchPlaceholder="Search team..."
            emptyMessage="No team members found."
            clearable
          />
        ) : project.secondary_lead ? (
          <div className="flex items-center gap-2">
            <div className="h-8 w-8 rounded-full bg-muted flex items-center justify-center">
              <span className="text-xs font-medium">
                {project.secondary_lead.full_name?.split(' ').map(n => n[0]).join('')}
              </span>
            </div>
            <span className="font-medium">{project.secondary_lead.full_name}</span>
          </div>
        ) : (
          <p className="text-muted-foreground">—</p>
        )}
      </div>

      {/* Project Manager */}
      <div>
        <p className="text-sm font-medium text-muted-foreground mb-1">Project Manager</p>
        {isEditing ? (
          <SearchableSelect
            options={userOptions}
            value={form.watch('pm_id') || ''}
            onValueChange={(value) => form.setValue('pm_id', value || '')}
            placeholder="Select PM..."
            searchPlaceholder="Search team..."
            emptyMessage="No team members found."
            clearable
          />
        ) : project.pm ? (
          <div className="flex items-center gap-2">
            <div className="h-8 w-8 rounded-full bg-muted flex items-center justify-center">
              <span className="text-xs font-medium">
                {project.pm.full_name?.split(' ').map(n => n[0]).join('')}
              </span>
            </div>
            <span className="font-medium">{project.pm.full_name}</span>
          </div>
        ) : (
          <p className="text-muted-foreground">—</p>
        )}
      </div>
    </div>
    <div className="mt-6 pt-4 border-t">
      <AuditTrail
        created_at={project.created_at}
        created_by={project.created_by}
        updated_at={project.updated_at}
        updated_by={project.updated_by}
        creator={project.creator}
        updater={project.updater}
      />
    </div>
  </CardContent>
</Card>
```

This pattern uses the same approach as SetDetailPage lines 574-674:
- Label Above / Value Below layout
- SearchableSelect in Edit Mode with clearable prop
- Avatar with initials in View Mode
- Graceful fallback to "—" when no team member assigned
  </action>
  <verify>
1. Run `npm run build` - should complete without errors
2. Run `npm run dev` and navigate to any project detail page
3. Click Edit - verify Lead, Secondary Lead, and PM show as searchable dropdowns
4. Select team members and click Save - verify changes persist on page refresh
  </verify>
  <done>
Team section displays SearchableSelect dropdowns in Edit Mode, avatar/initials in View Mode.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. Navigate to /projects/:id - page loads correctly
3. Click Edit button - Team section shows 3 searchable dropdowns
4. Select users in dropdowns - they appear selected
5. Click Save - no errors, team members saved
6. Refresh page - team members persist and display in View Mode
</verification>

<success_criteria>
- ProjectDetailPage has editable Lead, Secondary Lead, and PM dropdowns
- Dropdowns use SearchableSelect with clearable prop
- View Mode shows avatar initials for assigned team members
- Changes to team members persist to database
- Pattern matches SetDetailPage implementation for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/03-projects-sets-enhancement/03-01-SUMMARY.md`
</output>
