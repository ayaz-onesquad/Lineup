# Plan 06-03: Status Updates System UI

## Goal

Build UI components for the status updates system to enable timeline-style project updates visible to team and clients.

## Current State

- **Database:** `status_updates` table exists with fields:
  - `id`, `tenant_id`, `project_id`
  - `title`, `content`, `status_type`
  - `author_id`, `is_client_visible`
  - Audit fields
- **API:** `statusUpdatesApi` exists with CRUD operations
- **Hooks:** None
- **UI:** None

## Tasks

### Task 1: Create Status Update Hooks
- [ ] `useProjectStatusUpdates(projectId)` - fetch updates for project
- [ ] `useStatusUpdateMutations()` - create, update, delete
- [ ] Include author profile data

### Task 2: Create StatusUpdateCard Component
- [ ] Display single status update
- [ ] Show title, content (rich text), type badge
- [ ] Author avatar, name, date
- [ ] Client visibility indicator
- [ ] Edit/delete for author or admin

### Task 3: Create StatusUpdatesTimeline Component
- [ ] Vertical timeline layout
- [ ] Chronological order (newest first)
- [ ] "Post Update" button at top
- [ ] Filter by type (optional)
- [ ] Empty state

### Task 4: Create PostStatusUpdateDialog
- [ ] Fields: Title, Content (rich text), Type dropdown
- [ ] Client visibility toggle
- [ ] Preview before posting

### Task 5: Wire to ProjectDetailPage
- [ ] Add Status Updates tab to ProjectDetailPage
- [ ] Or add as a section in Details tab

### Task 6: Wire to Client Portal (if visible)
- [ ] Show client-visible updates in PortalProjectPage
- [ ] Read-only view for clients

## Implementation

### Hooks (src/hooks/useStatusUpdates.ts)

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { statusUpdatesApi } from '@/services/api'

export function useProjectStatusUpdates(projectId: string) {
  return useQuery({
    queryKey: ['status-updates', projectId],
    queryFn: () => statusUpdatesApi.getByProject(projectId),
    enabled: !!projectId,
  })
}

export function useStatusUpdateMutations() {
  const queryClient = useQueryClient()

  const createStatusUpdate = useMutation({
    mutationFn: statusUpdatesApi.create,
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: ['status-updates', variables.project_id],
      })
    },
  })

  const updateStatusUpdate = useMutation({
    mutationFn: ({ id, data }: { id: string; data: Partial<StatusUpdate> }) =>
      statusUpdatesApi.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['status-updates'] })
    },
  })

  const deleteStatusUpdate = useMutation({
    mutationFn: statusUpdatesApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['status-updates'] })
    },
  })

  return { createStatusUpdate, updateStatusUpdate, deleteStatusUpdate }
}
```

### StatusUpdatesTimeline Component

```typescript
interface StatusUpdatesTimelineProps {
  projectId: string
  canPost?: boolean
}

const STATUS_TYPES = [
  { value: 'progress', label: 'Progress Update', color: 'blue' },
  { value: 'milestone', label: 'Milestone', color: 'green' },
  { value: 'blocker', label: 'Blocker', color: 'red' },
  { value: 'announcement', label: 'Announcement', color: 'purple' },
]

export function StatusUpdatesTimeline({
  projectId,
  canPost = true,
}: StatusUpdatesTimelineProps) {
  const { data: updates, isLoading } = useProjectStatusUpdates(projectId)
  const [postDialogOpen, setPostDialogOpen] = useState(false)

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold flex items-center gap-2">
          <Clock className="h-5 w-5" />
          Status Updates
        </h3>
        {canPost && (
          <Button onClick={() => setPostDialogOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Post Update
          </Button>
        )}
      </div>

      {/* Timeline */}
      {isLoading ? (
        <Skeleton className="h-40" />
      ) : updates?.length === 0 ? (
        <Card className="p-6 text-center text-muted-foreground">
          No status updates yet.
          {canPost && ' Post one to keep the team informed!'}
        </Card>
      ) : (
        <div className="relative">
          {/* Vertical line */}
          <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-border" />

          {/* Updates */}
          <div className="space-y-4">
            {updates?.map((update, index) => (
              <StatusUpdateCard
                key={update.id}
                update={update}
                isFirst={index === 0}
              />
            ))}
          </div>
        </div>
      )}

      {/* Post dialog */}
      <PostStatusUpdateDialog
        projectId={projectId}
        open={postDialogOpen}
        onOpenChange={setPostDialogOpen}
      />
    </div>
  )
}
```

### StatusUpdateCard Component

```typescript
interface StatusUpdateCardProps {
  update: StatusUpdate
  isFirst?: boolean
}

export function StatusUpdateCard({ update, isFirst }: StatusUpdateCardProps) {
  const statusType = STATUS_TYPES.find(t => t.value === update.status_type)

  return (
    <div className="relative pl-10">
      {/* Timeline dot */}
      <div
        className={cn(
          'absolute left-2.5 w-3 h-3 rounded-full border-2 border-background',
          isFirst ? 'bg-primary' : 'bg-muted-foreground'
        )}
      />

      {/* Card */}
      <Card className="p-4">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            {/* Header */}
            <div className="flex items-center gap-2 mb-1">
              <Badge variant={statusType?.color as any}>
                {statusType?.label || update.status_type}
              </Badge>
              {update.is_client_visible && (
                <Badge variant="outline">
                  <Eye className="h-3 w-3 mr-1" />
                  Client Visible
                </Badge>
              )}
            </div>

            {/* Title */}
            <h4 className="font-semibold">{update.title}</h4>

            {/* Content */}
            <div
              className="mt-2 text-muted-foreground prose prose-sm"
              dangerouslySetInnerHTML={{ __html: update.content }}
            />

            {/* Footer */}
            <div className="flex items-center gap-2 mt-3 text-sm text-muted-foreground">
              <Avatar className="h-5 w-5">
                <AvatarImage src={update.author?.avatar_url} />
                <AvatarFallback>{update.author?.full_name?.[0]}</AvatarFallback>
              </Avatar>
              <span>{update.author?.full_name}</span>
              <span>â€¢</span>
              <span>{format(new Date(update.created_at), 'MMM d, yyyy')}</span>
            </div>
          </div>

          {/* Actions */}
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="icon">
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent>
              <DropdownMenuItem>Edit</DropdownMenuItem>
              <DropdownMenuItem className="text-destructive">Delete</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </Card>
    </div>
  )
}
```

### PostStatusUpdateDialog Component

```typescript
export function PostStatusUpdateDialog({
  projectId,
  open,
  onOpenChange,
}: PostStatusUpdateDialogProps) {
  const { createStatusUpdate } = useStatusUpdateMutations()
  const [title, setTitle] = useState('')
  const [content, setContent] = useState('')
  const [statusType, setStatusType] = useState('progress')
  const [isClientVisible, setIsClientVisible] = useState(false)

  const handleSubmit = async () => {
    await createStatusUpdate.mutateAsync({
      project_id: projectId,
      title,
      content,
      status_type: statusType,
      is_client_visible: isClientVisible,
    })
    toast.success('Status update posted!')
    onOpenChange(false)
    // Reset form
    setTitle('')
    setContent('')
    setStatusType('progress')
    setIsClientVisible(false)
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Post Status Update</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Update Type</Label>
              <Select value={statusType} onValueChange={setStatusType}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {STATUS_TYPES.map(type => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center gap-2">
              <Switch
                checked={isClientVisible}
                onCheckedChange={setIsClientVisible}
              />
              <Label>Visible to Client</Label>
            </div>
          </div>

          <div>
            <Label>Title</Label>
            <Input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Brief summary of this update"
            />
          </div>

          <div>
            <Label>Content</Label>
            <RichTextEditor
              value={content}
              onChange={setContent}
              placeholder="Provide details about this update..."
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={!title.trim() || createStatusUpdate.isPending}
          >
            Post Update
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

## ProjectDetailPage Integration

Add a new tab for Status Updates:

```typescript
// In ProjectDetailPage tabs
<TabsList>
  <TabsTrigger value="details">Details</TabsTrigger>
  <TabsTrigger value="phases">Phases</TabsTrigger>
  <TabsTrigger value="sets">Sets</TabsTrigger>
  <TabsTrigger value="updates">Status Updates</TabsTrigger>
</TabsList>

<TabsContent value="updates">
  <StatusUpdatesTimeline projectId={project.id} />
</TabsContent>
```

## Verification

- [ ] Status Updates tab appears in ProjectDetailPage
- [ ] Can post new status update with all fields
- [ ] Updates appear in chronological timeline
- [ ] Status type badges display correctly
- [ ] Client visibility indicator shows
- [ ] Can edit/delete own updates
- [ ] Client portal shows only client-visible updates

## Estimated Effort

Medium - 4-6 hours
