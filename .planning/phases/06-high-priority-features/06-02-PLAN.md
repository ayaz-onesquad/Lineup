# Plan 06-02: Discussions/Comments System UI

## Goal

Build UI components for the discussions system to enable threaded comments on any entity (clients, projects, sets, requirements, pitches, leads).

## Current State

- **Database:** `discussions` table exists with fields:
  - `id`, `tenant_id`, `entity_type`, `entity_id`
  - `parent_discussion_id` (for threading)
  - `content`, `author_id`
  - `is_resolved`, `resolved_by_id`, `resolved_at`
  - Audit fields
- **API:** `discussionsApi` exists with CRUD operations
- **Hooks:** None
- **UI:** None

## Tasks

### Task 1: Create Discussion Hooks
- [ ] `useEntityDiscussions(entityType, entityId)` - fetch discussions for entity
- [ ] `useDiscussionMutations()` - create, update, resolve, delete
- [ ] Include author profile data in queries

### Task 2: Create DiscussionThread Component
- [ ] Display single discussion with replies
- [ ] Show author avatar, name, timestamp
- [ ] Reply button to add child discussion
- [ ] Resolve/unresolve toggle for thread owner or admin
- [ ] Edit/delete for own comments

### Task 3: Create DiscussionsPanel Component
- [ ] Collapsible panel for entity detail pages
- [ ] List of discussions sorted by date
- [ ] "New Discussion" button/form
- [ ] Empty state when no discussions

### Task 4: Wire to Detail Pages
- [ ] Add DiscussionsPanel to ClientDetailPage
- [ ] Add DiscussionsPanel to ProjectDetailPage
- [ ] Add DiscussionsPanel to SetDetailPage
- [ ] Add DiscussionsPanel to RequirementDetailPage
- [ ] Add DiscussionsPanel to PitchDetailPage
- [ ] Add DiscussionsPanel to LeadDetailPage

### Task 5: Add Discussions Tab or Section
- [ ] Decide: Tab vs collapsible section vs sidebar
- [ ] Implement consistently across all detail pages

## Implementation

### Hooks (src/hooks/useDiscussions.ts)

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { discussionsApi } from '@/services/api'

export function useEntityDiscussions(entityType: string, entityId: string) {
  return useQuery({
    queryKey: ['discussions', entityType, entityId],
    queryFn: () => discussionsApi.getByEntity(entityType, entityId),
    enabled: !!entityType && !!entityId,
  })
}

export function useDiscussionMutations() {
  const queryClient = useQueryClient()

  const createDiscussion = useMutation({
    mutationFn: discussionsApi.create,
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: ['discussions', variables.entity_type, variables.entity_id],
      })
    },
  })

  const resolveDiscussion = useMutation({
    mutationFn: ({ id, resolved }: { id: string; resolved: boolean }) =>
      discussionsApi.update(id, { is_resolved: resolved }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['discussions'] })
    },
  })

  const deleteDiscussion = useMutation({
    mutationFn: discussionsApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['discussions'] })
    },
  })

  return { createDiscussion, resolveDiscussion, deleteDiscussion }
}
```

### DiscussionsPanel Component

```typescript
interface DiscussionsPanelProps {
  entityType: 'client' | 'project' | 'set' | 'requirement' | 'pitch' | 'lead'
  entityId: string
}

export function DiscussionsPanel({ entityType, entityId }: DiscussionsPanelProps) {
  const { data: discussions, isLoading } = useEntityDiscussions(entityType, entityId)
  const { createDiscussion } = useDiscussionMutations()
  const [newComment, setNewComment] = useState('')
  const { user } = useAuth()

  const handleSubmit = async () => {
    if (!newComment.trim()) return
    await createDiscussion.mutateAsync({
      entity_type: entityType,
      entity_id: entityId,
      content: newComment,
      author_id: user.id,
    })
    setNewComment('')
  }

  // Group discussions by thread (parent_discussion_id)
  const threads = useMemo(() => {
    if (!discussions) return []
    const topLevel = discussions.filter(d => !d.parent_discussion_id)
    return topLevel.map(parent => ({
      ...parent,
      replies: discussions.filter(d => d.parent_discussion_id === parent.id),
    }))
  }, [discussions])

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <MessageSquare className="h-5 w-5" />
          Discussions ({discussions?.length || 0})
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* New discussion form */}
        <div className="flex gap-2">
          <Textarea
            placeholder="Add a comment..."
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
            className="flex-1"
          />
          <Button
            onClick={handleSubmit}
            disabled={!newComment.trim() || createDiscussion.isPending}
          >
            Post
          </Button>
        </div>

        {/* Discussion threads */}
        {isLoading ? (
          <Skeleton className="h-20" />
        ) : threads.length === 0 ? (
          <p className="text-muted-foreground text-center py-4">
            No discussions yet. Start one above!
          </p>
        ) : (
          threads.map(thread => (
            <DiscussionThread key={thread.id} discussion={thread} />
          ))
        )}
      </CardContent>
    </Card>
  )
}
```

### DiscussionThread Component

```typescript
interface DiscussionThreadProps {
  discussion: Discussion & { replies: Discussion[] }
}

export function DiscussionThread({ discussion }: DiscussionThreadProps) {
  const [showReplyForm, setShowReplyForm] = useState(false)
  const { createDiscussion, resolveDiscussion } = useDiscussionMutations()

  return (
    <div className="border rounded-lg p-4 space-y-3">
      {/* Main comment */}
      <div className="flex gap-3">
        <Avatar className="h-8 w-8">
          <AvatarImage src={discussion.author?.avatar_url} />
          <AvatarFallback>{discussion.author?.full_name?.[0]}</AvatarFallback>
        </Avatar>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <span className="font-medium">{discussion.author?.full_name}</span>
            <span className="text-muted-foreground text-sm">
              {formatDistanceToNow(new Date(discussion.created_at))} ago
            </span>
            {discussion.is_resolved && (
              <Badge variant="success">Resolved</Badge>
            )}
          </div>
          <p className="mt-1">{discussion.content}</p>
          <div className="flex gap-2 mt-2">
            <Button variant="ghost" size="sm" onClick={() => setShowReplyForm(!showReplyForm)}>
              Reply
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => resolveDiscussion.mutate({
                id: discussion.id,
                resolved: !discussion.is_resolved
              })}
            >
              {discussion.is_resolved ? 'Unresolve' : 'Resolve'}
            </Button>
          </div>
        </div>
      </div>

      {/* Replies */}
      {discussion.replies.length > 0 && (
        <div className="ml-11 space-y-3 border-l-2 pl-4">
          {discussion.replies.map(reply => (
            <DiscussionReply key={reply.id} reply={reply} />
          ))}
        </div>
      )}

      {/* Reply form */}
      {showReplyForm && (
        <ReplyForm
          parentId={discussion.id}
          entityType={discussion.entity_type}
          entityId={discussion.entity_id}
          onSubmit={() => setShowReplyForm(false)}
        />
      )}
    </div>
  )
}
```

## Verification

- [ ] DiscussionsPanel renders on all detail pages
- [ ] Can create new discussion
- [ ] Can reply to existing discussion
- [ ] Replies show threaded under parent
- [ ] Can resolve/unresolve discussions
- [ ] Author info displays correctly
- [ ] Real-time updates after posting (via query invalidation)

## Estimated Effort

Medium - 4-6 hours
