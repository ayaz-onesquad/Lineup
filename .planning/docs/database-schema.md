# CORE Platform - Complete Database Documentation

## Table of Contents
1. [Module 1: System & Multi-Tenancy](#module-1-system--multi-tenancy)
2. [Module 2: Client Management](#module-2-client-management)
3. [Module 3: Project Hierarchy](#module-3-project-hierarchy)
4. [Module 4: Collaboration & Communication](#module-4-collaboration--communication)
5. [Module 5: Activity & Audit](#module-5-activity--audit)
6. [Database Relationships Diagram](#database-relationships-diagram)
7. [Cascading Delete Rules Summary](#cascading-delete-rules-summary)

---

# Module 1: System & Multi-Tenancy

## Purpose
Manages the foundational multi-tenant architecture, user accounts, and tenant memberships.

---

## Entity 1.1: tenants

**Purpose:** Represents an organization (agency) using the platform. Each tenant is completely isolated from others.

**Usage:** Created when a new organization signs up. All other data in the system belongs to a tenant.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the tenant | Primary Key, Auto-generated |
| name | VARCHAR(255) | Yes | Yes | No | Display name of the organization | e.g., "Acme Digital Agency" |
| slug | VARCHAR(100) | Yes | Yes | No | URL-friendly identifier | e.g., "acme-digital", Must be unique, lowercase, alphanumeric + hyphens |
| domain | VARCHAR(255) | No | Yes | No | Custom domain for the tenant | e.g., "acme.coreplatform.com", Optional |
| status | VARCHAR(50) | Yes | Yes | No | Current operational status | Values: 'active', 'suspended', 'cancelled', Default: 'active' |
| plan_tier | VARCHAR(50) | Yes | Yes | No | Subscription plan level | Values: 'starter', 'professional', 'business', 'enterprise', Default: 'starter' |
| max_users | INTEGER | Yes | Yes | No | Maximum allowed users for this tenant | Default: 10, Based on plan_tier |
| max_projects | INTEGER | Yes | Yes | No | Maximum allowed active projects | Default: 5, Based on plan_tier |
| max_storage_gb | INTEGER | Yes | Yes | No | Maximum storage in gigabytes | Default: 10, Based on plan_tier |
| stripe_customer_id | VARCHAR(255) | No | No | Yes | Stripe customer ID for billing | Populated by payment integration |
| subscription_status | VARCHAR(50) | No | No | Yes | Current subscription status | Values: 'trialing', 'active', 'past_due', 'cancelled', From Stripe |
| trial_ends_at | TIMESTAMP | No | Yes | No | When the trial period ends | NULL if no trial |
| settings | JSONB | Yes | Yes | No | Tenant-specific configuration | Default: '{}', Stores custom settings as JSON |
| created_at | TIMESTAMP | Yes | No | Yes | When tenant was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When tenant was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When tenant was soft deleted | NULL if active, Set for soft delete |

**Relationships:**
- Has many: tenant_users, clients, projects, phases, sets, requirements, documents, discussions, status_updates, activity_log, notifications

**On Delete:** 
- CASCADE to all related records (complete tenant deletion)
- **WARNING:** Deleting a tenant will delete ALL associated data permanently

**Indexes:**
- PRIMARY KEY on `id`
- UNIQUE INDEX on `slug`
- INDEX on `status` WHERE `deleted_at IS NULL`

---

## Entity 1.2: users

**Purpose:** Represents individual user accounts. Users can belong to multiple tenants with different roles.

**Usage:** Created when someone signs up. Managed by Supabase Auth but extended with profile information.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the user | Primary Key, Auto-generated by Supabase Auth |
| email | VARCHAR(255) | Yes | Yes | No | User's email address | Must be unique, Used for login |
| email_verified | BOOLEAN | Yes | No | Yes | Whether email has been verified | Default: false, Set by Supabase Auth |
| password_hash | VARCHAR(255) | No | No | Yes | Hashed password | NULL if using OAuth only, Managed by Supabase Auth |
| first_name | VARCHAR(100) | No | Yes | No | User's first name | Optional |
| last_name | VARCHAR(100) | No | Yes | No | User's last name | Optional |
| avatar_url | TEXT | No | Yes | No | URL to user's profile picture | Can be external URL or storage path |
| phone | VARCHAR(50) | No | Yes | No | User's phone number | Optional, For contact/MFA |
| timezone | VARCHAR(100) | Yes | Yes | No | User's timezone | Default: 'UTC', IANA timezone format |
| system_role | VARCHAR(50) | No | No | Yes | System-wide role (not tenant-specific) | Values: 'sysadmin', 'systester', NULL, Only for admin access |
| mfa_enabled | BOOLEAN | Yes | Yes | No | Whether MFA is enabled | Default: false |
| mfa_secret | VARCHAR(255) | No | No | Yes | TOTP secret for MFA | NULL if MFA not enabled, Encrypted |
| last_login_at | TIMESTAMP | No | No | Yes | Last successful login time | Updated on each login |
| login_count | INTEGER | Yes | No | Yes | Total number of logins | Default: 0, Increments on login |
| oauth_provider | VARCHAR(50) | No | No | Yes | OAuth provider used | Values: 'google', 'microsoft', 'github', NULL if email/password |
| oauth_provider_id | VARCHAR(255) | No | No | Yes | User ID from OAuth provider | NULL if email/password |
| created_at | TIMESTAMP | Yes | No | Yes | When user account was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When user profile was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When user was soft deleted | NULL if active |

**Relationships:**
- Has many: tenant_users (memberships in different tenants)
- Has many: created_clients, created_projects, created_phases, created_sets, created_requirements (as creator)
- Has many: led_projects (as project lead)
- Has many: owned_phases, owned_sets (as owner)
- Has many: assigned_requirements (as assignee)
- Has many: review_requirements (as reviewer)
- Has many: uploaded_documents, authored_discussions, authored_status_updates
- Has many: activity_log, notifications

**On Delete:** 
- SET NULL on created_by, lead_id, owner_id, assigned_to_id fields
- Keep historical records but anonymize: "Deleted User"
- **NOTE:** Don't allow hard delete if user has critical active assignments

**Indexes:**
- PRIMARY KEY on `id`
- UNIQUE INDEX on `email` WHERE `deleted_at IS NULL`
- INDEX on `system_role` WHERE `system_role IS NOT NULL`

---

## Entity 1.3: tenant_users

**Purpose:** Junction table linking users to tenants with role assignments. Enables multi-tenancy where one user can belong to multiple organizations.

**Usage:** Created when a user is invited to or joins a tenant. Determines access level within that tenant.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for this membership | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | Yes | No | The tenant this membership is for | Foreign Key to tenants(id) |
| user_id | UUID | Yes | Yes | No | The user being granted access | Foreign Key to users(id) |
| role | VARCHAR(50) | Yes | Yes | No | User's role within this tenant | Values: 'org_admin', 'org_user', 'client_user' |
| status | VARCHAR(50) | Yes | Yes | No | Status of this membership | Values: 'active', 'invited', 'suspended', Default: 'invited' |
| invitation_token | VARCHAR(255) | No | No | Yes | Unique token for accepting invitation | Generated when inviting, NULL after accepted |
| invited_by | UUID | No | No | Yes | User who sent the invitation | Foreign Key to users(id), NULL if self-signup |
| invited_at | TIMESTAMP | No | No | Yes | When invitation was sent | Set when invitation created |
| joined_at | TIMESTAMP | No | No | Yes | When user accepted invitation | NULL until accepted, Set when status becomes 'active' |
| custom_permissions | JSONB | Yes | Yes | No | Override permissions for this user | Default: '{}', For granular permission control |
| created_at | TIMESTAMP | Yes | No | Yes | When membership was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When membership was last updated | Auto-updated on change |

**Relationships:**
- Belongs to: tenant (the organization)
- Belongs to: user (the person)
- Belongs to: invited_by (user who sent invite)

**On Delete:** 
- CASCADE when tenant is deleted (remove all memberships)
- CASCADE when user is deleted (remove their memberships)
- **NOTE:** Prevent deleting if user is the last org_admin

**Indexes:**
- PRIMARY KEY on `id`
- UNIQUE INDEX on `(tenant_id, user_id)` - one membership per user per tenant
- INDEX on `tenant_id`
- INDEX on `user_id`
- INDEX on `(tenant_id, role)`
- INDEX on `invitation_token` WHERE `invitation_token IS NOT NULL`

**Constraints:**
- UNIQUE (tenant_id, user_id)
- CHECK: role IN ('org_admin', 'org_user', 'client_user')
- CHECK: status IN ('active', 'invited', 'suspended')

---

# Module 2: Client Management

## Purpose
Manages client profiles and contact information for agencies' customers.

---

## Entity 2.1: clients

**Purpose:** Represents a client/customer organization that the agency is working for. Each client can have multiple projects.

**Usage:** Created by agency staff when onboarding a new client. Central hub for all client-related projects.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the client | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this client belongs to | Foreign Key to tenants(id), Auto-set from context |
| name | VARCHAR(255) | Yes | Yes | No | Client's primary name/contact name | Required |
| company_name | VARCHAR(255) | No | Yes | No | Client's company name | Optional if same as name |
| email | VARCHAR(255) | No | Yes | No | Primary contact email | Optional |
| phone | VARCHAR(50) | No | Yes | No | Primary contact phone | Optional |
| website | VARCHAR(255) | No | Yes | No | Client's website URL | Optional |
| address_line1 | VARCHAR(255) | No | Yes | No | Street address line 1 | Optional |
| address_line2 | VARCHAR(255) | No | Yes | No | Street address line 2 | Optional |
| city | VARCHAR(100) | No | Yes | No | City | Optional |
| state | VARCHAR(100) | No | Yes | No | State/Province | Optional |
| country | VARCHAR(100) | No | Yes | No | Country | Optional |
| postal_code | VARCHAR(20) | No | Yes | No | ZIP/Postal code | Optional |
| industry | VARCHAR(100) | No | Yes | No | Client's industry | e.g., "Technology", "Healthcare" |
| company_size | VARCHAR(50) | No | Yes | No | Size of client company | Values: '1-10', '11-50', '51-200', '201-1000', '1000+' |
| portal_enabled | BOOLEAN | Yes | Yes | No | Whether client can access portal | Default: true |
| custom_branding | JSONB | Yes | Yes | No | Custom branding for client portal | Default: '{}', Stores logo URL, colors, etc. |
| notes | TEXT | No | Yes | No | Internal notes about client | Not visible to client |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}', Array of strings |
| status | VARCHAR(50) | Yes | Yes | No | Client status | Values: 'active', 'inactive', 'archived', Default: 'active' |
| created_by | UUID | No | No | Yes | User who created this client | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When client was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When client was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When client was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: created_by (user)
- Has many: projects

**On Delete:** 
- CASCADE from tenant (if tenant deleted, all clients deleted)
- Prevent delete if client has active projects (must archive projects first)
- Or: CASCADE to projects (if allowed, will delete all client's projects)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(tenant_id, status)`
- INDEX on `tags` USING GIN

**Constraints:**
- CHECK: status IN ('active', 'inactive', 'archived')

---

# Module 3: Project Hierarchy

## Purpose
Manages the core hierarchical structure: Projects → Phases → Sets → Requirements

---

## Entity 3.1: projects

**Purpose:** Represents a body of work for a client. Top level of the project hierarchy.

**Usage:** Created when starting new work for a client. Contains phases, sets, and requirements.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the project | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this project belongs to | Foreign Key to tenants(id), Auto-set from context |
| client_id | UUID | Yes | Yes | No | The client this project is for | Foreign Key to clients(id), Required |
| name | VARCHAR(255) | Yes | Yes | No | Project name | e.g., "Website Redesign" |
| description | TEXT | No | Yes | No | Detailed project description | Optional, Supports markdown |
| project_code | VARCHAR(50) | No | Yes | No | Short code for project | e.g., "ABC-001", Optional but recommended |
| lead_id | UUID | No | Yes | No | Project lead/manager | Foreign Key to users(id), Optional |
| team_member_ids | UUID[] | Yes | Yes | No | Team members on this project | Default: '{}', Array of user IDs |
| status | VARCHAR(50) | Yes | Yes | No | Current project status | Values: 'planning', 'active', 'on_hold', 'completed', 'cancelled', Default: 'planning' |
| health | VARCHAR(50) | Yes | Yes | No | Project health indicator | Values: 'on_track', 'at_risk', 'delayed', Default: 'on_track' |
| completion_percentage | INTEGER | Yes | No | Yes | Overall completion (0-100) | Calculated from phases/requirements, Default: 0 |
| expected_start_date | DATE | No | Yes | No | When project is expected to start | Optional |
| expected_end_date | DATE | No | Yes | No | When project is expected to complete | Optional |
| actual_start_date | DATE | No | Yes | No | When project actually started | Set when status changes to 'active' |
| actual_end_date | DATE | No | Yes | No | When project actually completed | Set when status changes to 'completed' |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether client can see this project | Default: true |
| budget_amount | DECIMAL(12,2) | No | Yes | No | Project budget | Optional, For future budgeting features |
| budget_currency | VARCHAR(3) | Yes | Yes | No | Currency for budget | Default: 'USD', ISO currency code |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}' |
| custom_fields | JSONB | Yes | Yes | No | Custom data fields | Default: '{}', For extensibility |
| created_by | UUID | No | No | Yes | User who created this project | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When project was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When project was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When project was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: client
- Belongs to: lead (user)
- Belongs to: created_by (user)
- Has many: project_phases, sets

**On Delete:** 
- CASCADE from tenant (if tenant deleted)
- CASCADE from client (if client deleted, all projects deleted)
- CASCADE to project_phases, sets (delete all child records)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `client_id` WHERE `deleted_at IS NULL`
- INDEX on `lead_id`
- INDEX on `(tenant_id, status)`
- INDEX on `show_in_client_portal` WHERE `show_in_client_portal = TRUE`

**Constraints:**
- CHECK: status IN ('planning', 'active', 'on_hold', 'completed', 'cancelled')
- CHECK: health IN ('on_track', 'at_risk', 'delayed')
- CHECK: completion_percentage >= 0 AND completion_percentage <= 100

**Triggers:**
- Update `completion_percentage` when child phases/requirements change
- Set `actual_start_date` when status changes to 'active'
- Set `actual_end_date` when status changes to 'completed'

---

## Entity 3.2: project_phases

**Purpose:** Represents major stages or phases within a project (e.g., Discovery, Design, Development).

**Usage:** Organizes work into sequential or parallel phases. Optional but recommended for larger projects.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the phase | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this phase belongs to | Foreign Key to tenants(id), Auto-set from context |
| project_id | UUID | Yes | Yes | No | The project this phase belongs to | Foreign Key to projects(id), Required |
| name | VARCHAR(255) | Yes | Yes | No | Phase name | e.g., "Discovery", "Design", "Development" |
| description | TEXT | No | Yes | No | Phase description | Optional |
| phase_order | INTEGER | Yes | Yes | No | Order of this phase in project | Default: 0, For manual sorting |
| predecessor_phase_id | UUID | No | Yes | No | Phase that must complete before this | Foreign Key to project_phases(id), NULL if no dependency |
| successor_phase_id | UUID | No | Yes | No | Phase that follows this one | Foreign Key to project_phases(id), NULL if no follower |
| status | VARCHAR(50) | Yes | Yes | No | Current phase status | Values: 'not_started', 'in_progress', 'completed', 'blocked', Default: 'not_started' |
| completion_percentage | INTEGER | Yes | No | Yes | Phase completion (0-100) | Calculated from sets/requirements |
| expected_start_date | DATE | No | Yes | No | Expected start date | Optional |
| expected_end_date | DATE | No | Yes | No | Expected end date | Optional |
| actual_start_date | DATE | No | Yes | No | Actual start date | Set when status changes to 'in_progress' |
| actual_end_date | DATE | No | Yes | No | Actual completion date | Set when status changes to 'completed' |
| owner_id | UUID | No | Yes | No | Phase owner/lead | Foreign Key to users(id), Optional |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether client can see this phase | Default: true, Inherits from project |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}' |
| custom_fields | JSONB | Yes | Yes | No | Custom data fields | Default: '{}' |
| created_by | UUID | No | No | Yes | User who created this phase | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When phase was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When phase was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When phase was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: project
- Belongs to: owner (user)
- Belongs to: created_by (user)
- Belongs to: predecessor_phase (self-reference)
- Belongs to: successor_phase (self-reference)
- Has many: sets

**On Delete:** 
- CASCADE from tenant
- CASCADE from project (if project deleted, all phases deleted)
- SET NULL on predecessor_phase_id, successor_phase_id (break dependencies)
- CASCADE to sets (delete all sets in this phase)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(project_id, phase_order)` WHERE `deleted_at IS NULL`
- INDEX on `status`
- INDEX on `predecessor_phase_id`

**Constraints:**
- CHECK: status IN ('not_started', 'in_progress', 'completed', 'blocked')
- CHECK: completion_percentage >= 0 AND completion_percentage <= 100

**Triggers:**
- Update `completion_percentage` when child sets/requirements change
- Update project's `completion_percentage` when this changes

---

## Entity 3.3: sets

**Purpose:** Represents a group of related requirements/tasks. Uses Eisenhower Matrix for prioritization.

**Usage:** Groups requirements logically (e.g., "Create Mockups", "Gather Requirements"). Can belong to a phase or directly to a project.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the set | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this set belongs to | Foreign Key to tenants(id), Auto-set from context |
| project_id | UUID | Yes | Yes | No | The project this set belongs to | Foreign Key to projects(id), Required |
| phase_id | UUID | No | Yes | No | The phase this set belongs to | Foreign Key to project_phases(id), NULL if project-level |
| name | VARCHAR(255) | Yes | Yes | No | Set name | e.g., "Create Homepage Mockups" |
| description | TEXT | No | Yes | No | Set description | Optional |
| set_order | INTEGER | Yes | Yes | No | Order of this set | Default: 0, For manual sorting |
| urgency | VARCHAR(50) | Yes | Yes | No | Eisenhower Matrix: Urgency level | Values: 'low', 'medium', 'high', Default: 'medium' |
| importance | VARCHAR(50) | Yes | Yes | No | Eisenhower Matrix: Importance level | Values: 'low', 'medium', 'high', Default: 'medium' |
| predecessor_set_id | UUID | No | Yes | No | Set that must complete before this | Foreign Key to sets(id), NULL if no dependency |
| successor_set_id | UUID | No | Yes | No | Set that follows this one | Foreign Key to sets(id), NULL if no follower |
| status | VARCHAR(50) | Yes | Yes | No | Current set status | Values: 'open', 'in_progress', 'completed', 'cancelled', Default: 'open' |
| completion_percentage | INTEGER | Yes | No | Yes | Set completion (0-100) | Calculated: (completed requirements / total requirements) × 100 |
| due_date | DATE | No | Yes | No | When set should be completed | Optional |
| owner_id | UUID | No | Yes | No | Set owner | Foreign Key to users(id), Optional |
| assigned_to_ids | UUID[] | Yes | Yes | No | Users assigned to this set | Default: '{}', Array of user IDs |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether client can see this set | Default: false, More granular than project |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}' |
| custom_fields | JSONB | Yes | Yes | No | Custom data fields | Default: '{}' |
| created_by | UUID | No | No | Yes | User who created this set | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When set was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When set was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When set was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: project
- Belongs to: phase (optional)
- Belongs to: owner (user)
- Belongs to: created_by (user)
- Belongs to: predecessor_set (self-reference)
- Belongs to: successor_set (self-reference)
- Has many: requirements

**On Delete:** 
- CASCADE from tenant
- CASCADE from project
- CASCADE from phase (if phase deleted, sets can stay with project or be deleted - configurable)
- SET NULL on predecessor_set_id, successor_set_id
- CASCADE to requirements (delete all requirements in this set)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `project_id` WHERE `deleted_at IS NULL`
- INDEX on `phase_id` WHERE `deleted_at IS NULL`
- INDEX on `(urgency, importance)` - For Eisenhower Matrix queries
- INDEX on `owner_id`
- INDEX on `(tenant_id, status)`

**Constraints:**
- CHECK: urgency IN ('low', 'medium', 'high')
- CHECK: importance IN ('low', 'medium', 'high')
- CHECK: status IN ('open', 'in_progress', 'completed', 'cancelled')
- CHECK: completion_percentage >= 0 AND completion_percentage <= 100

**Triggers:**
- Update `completion_percentage` when child requirements change
- Update phase/project `completion_percentage` when this changes

---

## Entity 3.4: requirements

**Purpose:** Represents individual tasks, deliverables, or action items. The most granular level of work.

**Usage:** Created within sets to track specific work items. Can require documents or reviews before completion.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the requirement | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this requirement belongs to | Foreign Key to tenants(id), Auto-set from context |
| set_id | UUID | Yes | Yes | No | The set this requirement belongs to | Foreign Key to sets(id), Required |
| title | VARCHAR(500) | Yes | Yes | No | Requirement title/summary | e.g., "Create homepage mockup" |
| description | TEXT | No | Yes | No | Detailed description | Optional, Supports markdown |
| requirement_order | INTEGER | Yes | Yes | No | Order within set | Default: 0, For manual sorting |
| requirement_type | VARCHAR(50) | Yes | Yes | No | Type of requirement | Values: 'task', 'open_item', 'technical', 'support', 'internal_deliverable', 'client_deliverable', 'internal_to_client_deliverable', Default: 'task' |
| status | VARCHAR(50) | Yes | Yes | No | Current status | Values: 'open', 'in_progress', 'blocked', 'completed', 'cancelled', Default: 'open' |
| requires_document | BOOLEAN | Yes | Yes | No | Must attach document to complete | Default: false, Enforced before marking complete |
| requires_review | BOOLEAN | Yes | Yes | No | Must be reviewed to complete | Default: false, Enforced before marking complete |
| reviewer_id | UUID | No | Yes | No | User who must review | Foreign Key to users(id), Required if requires_review = true |
| reviewed_at | TIMESTAMP | No | No | Yes | When review was completed | Set when reviewer approves |
| review_notes | TEXT | No | Yes | No | Reviewer's notes | Optional |
| predecessor_requirement_id | UUID | No | Yes | No | Requirement that must complete first | Foreign Key to requirements(id), NULL if no dependency |
| successor_requirement_id | UUID | No | Yes | No | Requirement that follows this | Foreign Key to requirements(id), NULL if no follower |
| blocked_by | TEXT | No | Yes | No | Free text: what's blocking this | Used when status = 'blocked' |
| due_date | DATE | No | Yes | No | When requirement should be done | Optional |
| estimated_hours | DECIMAL(6,2) | No | Yes | No | Estimated effort in hours | Optional, For time tracking |
| actual_hours | DECIMAL(6,2) | No | Yes | No | Actual effort spent in hours | Optional, User entered |
| completed_at | TIMESTAMP | No | No | Yes | When requirement was completed | Set when status changes to 'completed' |
| resolution_status | VARCHAR(50) | No | No | Yes | Resolution validation status | Track if document/review requirements met |
| assigned_to_id | UUID | No | Yes | No | User assigned to this requirement | Foreign Key to users(id), Optional |
| priority_override | VARCHAR(50) | No | Yes | No | Override inherited priority | Values: 'low', 'medium', 'high', 'critical', NULL = inherit from set |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether client can see this | Default: false |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}' |
| custom_fields | JSONB | Yes | Yes | No | Custom data fields | Default: '{}' |
| created_by | UUID | No | No | Yes | User who created this requirement | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When requirement was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When requirement was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When requirement was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: set
- Belongs to: assigned_to (user)
- Belongs to: reviewer (user)
- Belongs to: created_by (user)
- Belongs to: predecessor_requirement (self-reference)
- Belongs to: successor_requirement (self-reference)

**On Delete:** 
- CASCADE from tenant
- CASCADE from set (if set deleted, all requirements deleted)
- SET NULL on predecessor_requirement_id, successor_requirement_id
- SET NULL on assigned_to_id, reviewer_id

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(set_id, requirement_order)` WHERE `deleted_at IS NULL`
- INDEX on `requirement_type`
- INDEX on `(assigned_to_id, status)`
- INDEX on `(tenant_id, status)`
- INDEX on `reviewer_id` WHERE `requires_review = TRUE`

**Constraints:**
- CHECK: requirement_type IN ('task', 'open_item', 'technical', 'support', 'internal_deliverable', 'client_deliverable', 'internal_to_client_deliverable')
- CHECK: status IN ('open', 'in_progress', 'blocked', 'completed', 'cancelled')
- CHECK: priority_override IN ('low', 'medium', 'high', 'critical') OR priority_override IS NULL
- CHECK: IF requires_review = TRUE THEN reviewer_id IS NOT NULL

**Triggers:**
- Update set's `completion_percentage` when status changes
- Validate `requires_document` (check if document exists) before allowing completion
- Validate `requires_review` (check if reviewed) before allowing completion
- Set `completed_at` when status changes to 'completed'

**Business Rules:**
- Cannot mark as 'completed' if `requires_document = true` and no document attached
- Cannot mark as 'completed' if `requires_review = true` and not reviewed
- Cannot mark as 'completed' if predecessor requirement is not completed

---

# Module 4: Collaboration & Communication

## Purpose
Manages documents, discussions (comments), and status updates that can be attached to any entity in the system.

---

## Entity 4.1: documents

**Purpose:** Stores metadata for files uploaded to any entity in the system. Actual files stored in cloud storage (Supabase Storage).

**Usage:** Upload supporting files (PDFs, images, documents) to clients, projects, phases, sets, or requirements.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the document | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this document belongs to | Foreign Key to tenants(id), Auto-set from context |
| name | VARCHAR(255) | Yes | Yes | No | Display name for the file | e.g., "Project Brief.pdf" |
| description | TEXT | No | Yes | No | Description of document contents | Optional |
| file_url | TEXT | Yes | No | Yes | URL to file in cloud storage | Generated after upload to Supabase Storage |
| file_type | VARCHAR(100) | Yes | No | Yes | MIME type of file | e.g., "application/pdf", "image/png" |
| file_size_bytes | BIGINT | Yes | No | Yes | File size in bytes | For storage quota tracking |
| entity_type | VARCHAR(50) | Yes | Yes | No | Type of entity this links to | Values: 'client', 'project', 'phase', 'set', 'requirement' |
| entity_id | UUID | Yes | Yes | No | ID of the linked entity | UUID of the parent entity |
| version | INTEGER | Yes | No | Yes | Version number of this document | Default: 1, Increment for new versions |
| is_latest_version | BOOLEAN | Yes | No | Yes | Whether this is the latest version | Default: true, Only one version should be true |
| previous_version_id | UUID | No | No | Yes | Previous version of this document | Foreign Key to documents(id), NULL for first version |
| visibility | VARCHAR(50) | Yes | Yes | No | Who can see this document | Values: 

# CORE Platform - Database Documentation (Continued)

## Entity 4.1: documents (continued)

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| visibility | VARCHAR(50) | Yes | Yes | No | Who can see this document | Values: 'internal', 'client', 'public', Default: 'internal' |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether visible in client portal | Default: false |
| tags | TEXT[] | Yes | Yes | No | Tags for categorization | Default: '{}' |
| uploaded_by | UUID | No | No | Yes | User who uploaded this document | Foreign Key to users(id) |
| created_at | TIMESTAMP | Yes | No | Yes | When document was uploaded | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When document metadata was updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When document was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: uploaded_by (user)
- Belongs to: previous_version (document, self-reference)
- Has many: next_versions (documents that replaced this)
- Polymorphic: Can belong to client, project, phase, set, or requirement

**On Delete:** 
- CASCADE from tenant
- When entity is deleted (project, set, etc.), CASCADE delete documents
- SET NULL on uploaded_by
- When document deleted, also delete file from Supabase Storage (via trigger/application logic)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(entity_type, entity_id)` WHERE `deleted_at IS NULL`
- INDEX on `uploaded_by`
- INDEX on `show_in_client_portal` WHERE `show_in_client_portal = TRUE`

**Constraints:**
- CHECK: entity_type IN ('client', 'project', 'phase', 'set', 'requirement')
- CHECK: visibility IN ('internal', 'client', 'public')

**Business Rules:**
- File uploads must not exceed tenant's storage quota
- Only one version should have `is_latest_version = true` per document chain
- When uploading new version, set previous version's `is_latest_version = false`

---

## Entity 4.2: discussions

**Purpose:** Threaded comments/discussions that can be attached to any entity. Supports internal and client-visible comments.

**Usage:** Team collaboration and client communication on specific entities.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the discussion | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this discussion belongs to | Foreign Key to tenants(id), Auto-set from context |
| entity_type | VARCHAR(50) | Yes | Yes | No | Type of entity this comment is on | Values: 'client', 'project', 'phase', 'set', 'requirement' |
| entity_id | UUID | Yes | Yes | No | ID of the entity being commented on | UUID of parent entity |
| parent_discussion_id | UUID | No | Yes | No | Parent comment for threading | Foreign Key to discussions(id), NULL for top-level comments |
| thread_level | INTEGER | Yes | No | Yes | Depth in thread (0 = top level) | Calculated from parent relationships, Default: 0 |
| content | TEXT | Yes | Yes | No | The comment text | Required, Supports markdown |
| content_html | TEXT | No | No | Yes | Rendered HTML version | Generated from markdown content |
| mentioned_user_ids | UUID[] | Yes | Yes | No | Users @mentioned in comment | Default: '{}', Array of user IDs for notifications |
| is_internal | BOOLEAN | Yes | Yes | No | Whether comment is internal only | Default: true, false = visible to clients |
| is_resolved | BOOLEAN | Yes | Yes | No | Whether discussion thread is resolved | Default: false, For tracking issue resolution |
| resolved_by | UUID | No | No | Yes | User who marked as resolved | Foreign Key to users(id), NULL if not resolved |
| resolved_at | TIMESTAMP | No | No | Yes | When marked as resolved | NULL if not resolved |
| author_id | UUID | Yes | No | Yes | User who wrote this comment | Foreign Key to users(id), Auto-set from auth context |
| edited_at | TIMESTAMP | No | No | Yes | When comment was last edited | NULL if never edited |
| created_at | TIMESTAMP | Yes | No | Yes | When comment was created | Auto-set on insert |
| updated_at | TIMESTAMP | Yes | No | Yes | When comment was last updated | Auto-updated on change |
| deleted_at | TIMESTAMP | No | No | Yes | When comment was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: author (user)
- Belongs to: resolved_by (user)
- Belongs to: parent_discussion (self-reference)
- Has many: replies (discussions)
- Polymorphic: Can belong to client, project, phase, set, or requirement

**On Delete:** 
- CASCADE from tenant
- When entity is deleted, CASCADE delete discussions
- SET NULL on author_id (show "Deleted User")
- CASCADE when parent_discussion is deleted (delete entire thread)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(entity_type, entity_id)` WHERE `deleted_at IS NULL`
- INDEX on `parent_discussion_id`
- INDEX on `author_id`
- INDEX on `mentioned_user_ids` USING GIN

**Constraints:**
- CHECK: entity_type IN ('client', 'project', 'phase', 'set', 'requirement')
- CHECK: thread_level >= 0

**Business Rules:**
- Client users can only see comments where `is_internal = false`
- Cannot reply to a comment more than 3 levels deep (flat thread at that point)
- @mentions should trigger notifications

---

## Entity 4.3: status_updates

**Purpose:** Activity log entries that show progress, milestones, and status changes for entities.

**Usage:** Communicate progress to team and clients. Appears in activity feeds and timelines.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the update | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | The agency this update belongs to | Foreign Key to tenants(id), Auto-set from context |
| entity_type | VARCHAR(50) | Yes | Yes | No | Type of entity being updated | Values: 'project', 'phase', 'set', 'requirement' |
| entity_id | UUID | Yes | Yes | No | ID of the entity being updated | UUID of parent entity |
| title | VARCHAR(255) | No | Yes | No | Update title/headline | Optional, e.g., "Milestone Reached" |
| content | TEXT | Yes | Yes | No | Main update content | Required, Supports markdown |
| update_type | VARCHAR(50) | Yes | Yes | No | Type of update | Values: 'general', 'milestone', 'blocker', 'completed', 'status_change', Default: 'general' |
| previous_status | VARCHAR(50) | No | No | Yes | Status before change | Auto-captured if status changed |
| new_status | VARCHAR(50) | No | No | Yes | Status after change | Auto-captured if status changed |
| show_in_client_portal | BOOLEAN | Yes | Yes | No | Whether visible to clients | Default: false |
| author_id | UUID | Yes | No | Yes | User who created this update | Foreign Key to users(id), Auto-set from auth context |
| created_at | TIMESTAMP | Yes | No | Yes | When update was posted | Auto-set on insert |
| deleted_at | TIMESTAMP | No | No | Yes | When update was soft deleted | NULL if active |

**Relationships:**
- Belongs to: tenant
- Belongs to: author (user)
- Polymorphic: Can belong to project, phase, set, or requirement

**On Delete:** 
- CASCADE from tenant
- When entity is deleted, CASCADE delete status updates
- SET NULL on author_id (show "Deleted User")

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `tenant_id` WHERE `deleted_at IS NULL`
- INDEX on `(entity_type, entity_id, created_at DESC)`
- INDEX on `author_id`
- INDEX on `update_type`

**Constraints:**
- CHECK: entity_type IN ('project', 'phase', 'set', 'requirement')
- CHECK: update_type IN ('general', 'milestone', 'blocker', 'completed', 'status_change')

**Business Rules:**
- Automatically create status_update when status changes on entities
- Client portal filters to only show `show_in_client_portal = true`

---

# Module 5: Activity & Audit

## Purpose
System-wide logging and notifications for tracking changes and alerting users.

---

## Entity 5.1: activity_log

**Purpose:** Comprehensive audit trail of all actions in the system. For compliance, debugging, and security.

**Usage:** Automatically logged by system. Not directly edited by users.

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for this log entry | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | Tenant context for this action | Foreign Key to tenants(id), Auto-set from context |
| user_id | UUID | No | No | Yes | User who performed the action | Foreign Key to users(id), NULL for system actions |
| user_email | VARCHAR(255) | No | No | Yes | Email of user (denormalized) | Preserved even if user deleted |
| action | VARCHAR(100) | Yes | No | Yes | Action performed | Values: 'created', 'updated', 'deleted', 'viewed', 'exported', 'login', 'logout' |
| entity_type | VARCHAR(50) | Yes | No | Yes | Type of entity affected | Values: 'tenant', 'user', 'client', 'project', 'phase', 'set', 'requirement', 'document', 'discussion' |
| entity_id | UUID | Yes | No | Yes | ID of affected entity | UUID of the entity |
| changes | JSONB | No | No | Yes | Field-level changes | Format: {"field": {"old": value, "new": value}} |
| ip_address | INET | No | No | Yes | IP address of request | For security tracking |
| user_agent | TEXT | No | No | Yes | Browser/client user agent | For debugging |
| request_id | UUID | No | No | Yes | Unique request identifier | For tracing related actions |
| created_at | TIMESTAMP | Yes | No | Yes | When action occurred | Auto-set on insert |

**Relationships:**
- Belongs to: tenant
- Belongs to: user
- References any entity via entity_type + entity_id

**On Delete:** 
- CASCADE from tenant (when tenant deleted, delete all logs)
- NO CASCADE from user (preserve audit trail even if user deleted)
- NO CASCADE from entities (preserve history even if entity deleted)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `(tenant_id, created_at DESC)`
- INDEX on `(user_id, created_at DESC)`
- INDEX on `(entity_type, entity_id, created_at DESC)`
- INDEX on `action`

**Business Rules:**
- Append-only table (no updates or deletes except tenant deletion)
- Retention policy: Keep 90 days online, archive older to cold storage
- Sensitive fields should be redacted from `changes` JSON

---

## Entity 5.2: notifications

**Purpose:** In-app and email notifications for users about relevant activities.

**Usage:** Automatically generated by system events (mentions, assignments, comments, etc.).

| Field Name | Data Type | Required | User Entered | Calculated | Definition | Constraints |
|------------|-----------|----------|--------------|------------|------------|-------------|
| id | UUID | Yes | No | Yes | Unique identifier for the notification | Primary Key, Auto-generated |
| tenant_id | UUID | Yes | No | Yes | Tenant context | Foreign Key to tenants(id), Auto-set from context |
| user_id | UUID | Yes | No | Yes | User receiving this notification | Foreign Key to users(id) |
| type | VARCHAR(50) | Yes | No | Yes | Type of notification | Values: 'mention', 'assignment', 'status_change', 'comment', 'review_request', 'deadline' |
| title | VARCHAR(255) | Yes | No | Yes | Notification headline | e.g., "You were mentioned in a comment" |
| message | TEXT | No | No | Yes | Notification body text | Optional, More details |
| entity_type | VARCHAR(50) | No | No | Yes | Related entity type | Values: 'project', 'set', 'requirement', 'discussion', NULL if general |
| entity_id | UUID | No | No | Yes | Related entity ID | UUID of related entity, NULL if general |
| actor_id | UUID | No | No | Yes | User who triggered notification | Foreign Key to users(id), e.g., who mentioned you |
| read | BOOLEAN | Yes | Yes | No | Whether user has read this | Default: false |
| read_at | TIMESTAMP | No | No | Yes | When user read this | NULL until read |
| email_sent | BOOLEAN | Yes | No | Yes | Whether email was sent | Default: false |
| email_sent_at | TIMESTAMP | No | No | Yes | When email was sent | NULL if not sent |
| data | JSONB | Yes | No | Yes | Additional context data | Default: '{}', Extra info for rendering |
| created_at | TIMESTAMP | Yes | No | Yes | When notification was created | Auto-set on insert |

**Relationships:**
- Belongs to: tenant
- Belongs to: user (recipient)
- Belongs to: actor (user who triggered it)
- References entity via entity_type + entity_id

**On Delete:** 
- CASCADE from tenant
- CASCADE from user (recipient) - delete their notifications
- SET NULL on actor_id (preserve notification but anonymize actor)
- SET NULL on entity_id when entity is deleted (preserve notification)

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `(user_id, read, created_at DESC)` - For fetching unread notifications
- INDEX on `tenant_id`
- INDEX on `(entity_type, entity_id)`

**Constraints:**
- CHECK: type IN ('mention', 'assignment', 'status_change', 'comment', 'review_request', 'deadline')
- CHECK: entity_type IN ('project', 'phase', 'set', 'requirement', 'discussion') OR entity_type IS NULL

**Business Rules:**
- Mark as read when user clicks notification
- Send email if user has email notifications enabled (check user preferences)
- Batch digest emails if user prefers (send summary instead of individual emails)
- Delete notifications older than 90 days if read

---

# Database Relationships Diagram

```
┌──────────────────────────────────────────────────────────────────────┐
│                         MULTI-TENANCY LAYER                          │
└──────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
              ┌──────────┐                    ┌──────────┐
              │ tenants  │                    │  users   │
              └──────────┘                    └──────────┘
                    │                               │
                    │     ┌─────────────────────────┤
                    │     │                         │
                    │  ┌──────────────┐             │
                    └─►│ tenant_users │◄────────────┘
                       └──────────────┘
                              │ (defines role in tenant)
                              │
┌─────────────────────────────┴─────────────────────────────────────────┐
│                        TENANT-SCOPED DATA                             │
└───────────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
       ┌─────────┐      ┌──────────┐     ┌───────────┐
       │ clients │      │ projects │     │documents  │
       └─────────┘      └──────────┘     │discussions│
            │                 │           │status_    │
            │                 │           │updates    │
            └────────┬────────┘           └───────────┘
                     │                          │
                     │                          │ (polymorphic)
                     │                          │
              ┌─────────────┐                  │
              │   projects  │◄─────────────────┘
              └─────────────┘
                     │
                     │
              ┌──────────────┐
              │project_phases│
              └──────────────┘
                     │
                     │
              ┌──────────────┐
              │     sets     │
              └──────────────┘
                     │
                     │
              ┌──────────────┐
              │ requirements │
              └──────────────┘

┌───────────────────────────────────────────────────────────────────────┐
│                          AUDIT & SYSTEM                               │
└───────────────────────────────────────────────────────────────────────┘
                              │
                 ┌────────────┴────────────┐
                 │                         │
         ┌───────────────┐         ┌──────────────┐
         │ activity_log  │         │notifications │
         └───────────────┘         └──────────────┘
```

---

# Cascading Delete Rules Summary

## Complete Cascading Behavior

### When TENANT is deleted:
```
tenant
├─ CASCADE → tenant_users (all memberships)
├─ CASCADE → clients
│  └─ CASCADE → projects
│     ├─ CASCADE → project_phases
│     │  └─ CASCADE → sets
│     │     └─ CASCADE → requirements
│     └─ CASCADE → sets (project-level)
│        └─ CASCADE → requirements
├─ CASCADE → documents
├─ CASCADE → discussions
├─ CASCADE → status_updates
├─ CASCADE → activity_log
└─ CASCADE → notifications
```

**Result:** Complete removal of all tenant data (nuclear option)

---

### When USER is deleted:
```
user
├─ CASCADE → tenant_users (remove memberships)
├─ SET NULL → created_by fields (clients, projects, etc.)
├─ SET NULL → lead_id (projects)
├─ SET NULL → owner_id (phases, sets)
├─ SET NULL → assigned_to_id (requirements)
├─ SET NULL → reviewer_id (requirements)
├─ SET NULL → uploaded_by (documents)
├─ SET NULL → author_id (discussions, status_updates)
├─ KEEP → activity_log (preserve audit trail, use user_email)
├─ CASCADE → notifications (where user is recipient)
└─ SET NULL → actor_id (notifications where user triggered)
```

**Result:** User removed but historical records preserved

---

### When CLIENT is deleted:
```
client
├─ CASCADE → projects
│  ├─ CASCADE → project_phases
│  │  └─ CASCADE → sets
│  │     └─ CASCADE → requirements
│  └─ CASCADE → sets (project-level)
│     └─ CASCADE → requirements
├─ CASCADE → documents (entity_type='client')
├─ CASCADE → discussions (entity_type='client')
└─ NO CASCADE → status_updates (keep historical)
```

**Result:** Client and all their projects deleted

**Protection:** Can add constraint to prevent deletion if active projects exist

---

### When PROJECT is deleted:
```
project
├─ CASCADE → project_phases
│  └─ CASCADE → sets (in phases)
│     └─ CASCADE → requirements
├─ CASCADE → sets (project-level)
│  └─ CASCADE → requirements
├─ CASCADE → documents (entity_type='project')
├─ CASCADE → discussions (entity_type='project')
└─ CASCADE → status_updates (entity_type='project')
```

**Result:** Complete project hierarchy deleted

---

### When PROJECT_PHASE is deleted:
```
project_phase
├─ CASCADE → sets (in this phase)
│  └─ CASCADE → requirements
├─ SET NULL → predecessor_phase_id (break dependencies)
├─ SET NULL → successor_phase_id (break dependencies)
├─ CASCADE → documents (entity_type='phase')
├─ CASCADE → discussions (entity_type='phase')
└─ CASCADE → status_updates (entity_type='phase')
```

**Alternative:** SET NULL on phase_id in sets (keep sets, move to project level)

---

### When SET is deleted:
```
set
├─ CASCADE → requirements
├─ SET NULL → predecessor_set_id (break dependencies)
├─ SET NULL → successor_set_id (break dependencies)
├─ CASCADE → documents (entity_type='set')
├─ CASCADE → discussions (entity_type='set')
└─ CASCADE → status_updates (entity_type='set')
```

---

### When REQUIREMENT is deleted:
```
requirement
├─ SET NULL → predecessor_requirement_id
├─ SET NULL → successor_requirement_id
├─ CASCADE → documents (entity_type='requirement')
├─ CASCADE → discussions (entity_type='requirement')
└─ CASCADE → status_updates (entity_type='requirement')
```

---

### When DISCUSSION is deleted:
```
discussion
└─ CASCADE → replies (child discussions where parent_discussion_id matches)
```

**Result:** Delete entire thread

---

## Protection Strategies

### Prevent Accidental Deletion

**Soft Delete First:**
All main entities use `deleted_at` timestamp:
```sql
-- Don't do hard delete
DELETE FROM projects WHERE id = 'xxx';

-- Do soft delete instead
UPDATE projects SET deleted_at = NOW() WHERE id = 'xxx';
```

**Restore Capability:**
```sql
-- Restore soft-deleted entity
UPDATE projects SET deleted_at = NULL WHERE id = 'xxx';
```

**Hard Delete Schedule:**
- Keep soft-deleted records for 30 days
- After 30 days, can permanently delete (or keep indefinitely)

### Business Rule Validations

**Before Delete Checks:**
```sql
-- Cannot delete client with active projects
CREATE FUNCTION prevent_client_delete_if_active_projects()
RETURNS TRIGGER AS $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM projects 
    WHERE client_id = OLD.id 
    AND status IN ('planning', 'active') 
    AND deleted_at IS NULL
  ) THEN
    RAISE EXCEPTION 'Cannot delete client with active projects';
  END IF;
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_client_delete
  BEFORE DELETE ON clients
  FOR EACH ROW
  EXECUTE FUNCTION prevent_client_delete_if_active_projects();
```

**Cannot Delete Last org_admin:**
```sql
-- Prevent removing last admin
CREATE FUNCTION prevent_last_admin_removal()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.role = 'org_admin' AND 
     (SELECT COUNT(*) FROM tenant_users 
      WHERE tenant_id = OLD.tenant_id 
      AND role = 'org_admin' 
      AND id != OLD.id) = 0 
  THEN
    RAISE EXCEPTION 'Cannot remove last organization admin';
  END IF;
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;
```

---

## Data Retention Policies

| Entity | Soft Delete Period | Hard Delete Policy |
|--------|-------------------|-------------------|
| Tenants | 90 days | After 90 days or on request |
| Users | Never | Convert to "Deleted User" placeholder |
| Clients | 30 days | After 30 days if no historical data needed |
| Projects | 30 days | Archive to cold storage after 1 year |
| Requirements | 30 days | Permanent after 30 days (included in project archive) |
| Documents | 30 days | Delete from storage after 30 days |
| Discussions | 30 days | Permanent after 30 days |
| Status Updates | Never | Keep for project history |
| Activity Log | Never | Retain 90 days online, archive older to cold storage |
| Notifications | 90 days | Delete after 90 days if read |

---

# Field Type Reference

## Common Data Types Used

| Type | Description | Example Values | Notes |
|------|-------------|----------------|-------|
| UUID | Universally unique identifier | `550e8400-e29b-41d4-a716-446655440000` | Generated by `uuid_generate_v4()` |
| VARCHAR(n) | Variable-length string | `"Hello"` | Maximum n characters |
| TEXT | Unlimited string | Long descriptions | No length limit |
| INTEGER | Whole number | `42`, `-10` | 32-bit signed |
| BIGINT | Large whole number | `9223372036854775807` | 64-bit signed, for file sizes |
| DECIMAL(p,s) | Precise decimal | `123.45` | p=precision (total digits), s=scale (after decimal) |
| BOOLEAN | True/false | `TRUE`, `FALSE` | Also accepts `t`, `f`, `1`, `0` |
| DATE | Calendar date | `2024-03-15` | No time component |
| TIMESTAMP | Date with time | `2024-03-15 14:30:00` | Without timezone |
| TIMESTAMP WITH TIME ZONE | Date with time and zone | `2024-03-15 14:30:00-05` | Recommended for timestamps |
| JSONB | JSON binary format | `{"key": "value"}` | Indexed and queryable |
| TEXT[] | Array of text | `{"tag1", "tag2"}` | PostgreSQL array type |
| UUID[] | Array of UUIDs | `{uuid1, uuid2}` | For lists of IDs |
| INET | IP address | `192.168.1.1` | IPv4 or IPv6 |

---

# Indexing Strategy

## Primary Keys
Every table has UUID primary key: `id UUID PRIMARY KEY`

## Foreign Keys
Index all foreign keys for join performance:
- `tenant_id` - In ALL tenant-scoped tables
- `user_id`, `client_id`, `project_id`, etc.

## Common Query Patterns

**Multi-tenant isolation:**
```sql
INDEX ON table_name(tenant_id) WHERE deleted_at IS NULL;
```

**Status filtering:**
```sql
INDEX ON table_name(tenant_id, status) WHERE deleted_at IS NULL;
```

**User assignments:**
```sql
INDEX ON requirements(assigned_to_id, status) WHERE deleted_at IS NULL;
```

**Time-ordered queries:**
```sql
INDEX ON activity_log(tenant_id, created_at DESC);
INDEX ON notifications(user_id, read, created_at DESC);
```

**Polymorphic relationships:**
```sql
INDEX ON documents(entity_type, entity_id) WHERE deleted_at IS NULL;
INDEX ON discussions(entity_type, entity_id) WHERE deleted_at IS NULL;
```

**Full-text search (future):**
```sql
INDEX ON projects USING GIN(to_tsvector('english', name || ' ' || description));
```

**Array fields:**
```sql
INDEX ON clients USING GIN(tags);
INDEX ON discussions USING GIN(mentioned_user_ids);
```

---

# Performance Considerations

## Row Level Security (RLS) Impact
- RLS policies add WHERE clauses to every query
- But provides security guarantee at database level
- Performance impact: ~5-10% for simple queries
- Worth it for security and simplification

## Query Optimization Tips

**Always filter by tenant_id:**
```sql
-- Good
SELECT * FROM projects WHERE tenant_id = 'xxx' AND status = 'active';

-- Bad (scans entire table)
SELECT * FROM projects WHERE status = 'active';
```

**Use covering indexes for hot paths:**
```sql
-- If you often query: WHERE tenant_id = X AND status = Y
CREATE INDEX idx_projects_tenant_status 
ON projects(tenant_id, status) 
INCLUDE (name, completion_percentage)
WHERE deleted_at IS NULL;
```

**Pagination with LIMIT/OFFSET:**
```sql
-- Good for first pages
SELECT * FROM projects ORDER BY created_at DESC LIMIT 20 OFFSET 0;

-- Better for deep pagination (use cursor)
SELECT * FROM projects 
WHERE created_at < 'last_seen_timestamp'
ORDER BY created_at DESC 
LIMIT 20;
```

---

# Summary Statistics

## Database Size Estimates

**For a typical agency (50 users, 100 projects/year):**

| Table | Estimated Rows | Storage per Row | Total Storage |
|-------|----------------|-----------------|---------------|
| tenants | 1 | 1 KB | 1 KB |
| users | 50 | 2 KB | 100 KB |
| tenant_users | 50 | 500 bytes | 25 KB |
| clients | 30 | 2 KB | 60 KB |
| projects | 100 | 3 KB | 300 KB |
| project_phases | 400 | 2 KB | 800 KB |
| sets | 2,000 | 2 KB | 4 MB |
| requirements | 10,000 | 2 KB | 20 MB |
| documents | 500 | 1 KB | 500 KB |
| discussions | 5,000 | 1 KB | 5 MB |
| status_updates | 2,000 | 1 KB | 2 MB |
| activity_log | 50,000 | 500 bytes | 25 MB |
| notifications | 10,000 | 500 bytes | 5 MB |

**Total Database:** ~65 MB (excluding file storage)
**File Storage:** 10-100 GB (depends on usage)

## Query Complexity

**Simple queries:** 1-5ms
- Get single entity by ID
- List with tenant filter

**Medium queries:** 5-50ms
- List with joins (project + client)
- Filtered lists with pagination

**Complex queries:** 50-500ms
- Hierarchical data (full project tree)
- Dashboard with aggregations
- Reports with multiple joins

**Target SLA:**
- P95 latency < 100ms for all queries
- P99 latency < 500ms
